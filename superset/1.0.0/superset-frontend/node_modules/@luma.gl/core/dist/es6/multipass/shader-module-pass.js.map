{"version":3,"sources":["../../../src/multipass/shader-module-pass.js"],"names":["Pass","CompositePass","ClipSpace","normalizeShaderModule","ShaderModuleSinglePass","constructor","gl","props","Object","assign","swap","_renderPass","inputBuffer","swapBuffers","model","setUniforms","draw","uniforms","texture","texSize","width","height","parameters","depthWrite","depthTest","ShaderModulePass","module","id","name","passes","normalizePasses","first","pass","filter","sampler","fs","getFragmentShaderForRenderPass","getModel","map","idn","length","modules","getUniforms","FILTER_FS_TEMPLATE","func","SAMPLER_FS_TEMPLATE"],"mappings":"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","sourcesContent":["//\n// A pass that renders a given texture into screen space\n//\n\nimport Pass from './pass';\nimport CompositePass from './composite-pass';\nimport ClipSpace from '../lib/clip-space';\n\nimport {normalizeShaderModule} from '@luma.gl/shadertools';\n\nclass ShaderModuleSinglePass extends Pass {\n  constructor(gl, props = {}) {\n    super(gl, Object.assign({swap: true}, props));\n  }\n\n  _renderPass({inputBuffer, swapBuffers}) {\n    this.props.model.setUniforms(this.props);\n\n    // swapBuffers();\n    this.props.model.draw({\n      uniforms: {\n        texture: inputBuffer,\n        texSize: [inputBuffer.width, inputBuffer.height]\n      },\n      parameters: {\n        depthWrite: false,\n        depthTest: false\n      }\n    });\n  }\n}\n\nexport default class ShaderModulePass extends CompositePass {\n  constructor(gl, module, props = {}) {\n    const id = `${module.name}-pass`;\n    normalizeShaderModule(module);\n    const passes = normalizePasses(gl, module, id, props);\n    super(gl, Object.assign({id, passes}, props));\n    this.module = module;\n  }\n\n  _renderPass({inputBuffer, swapBuffers}) {\n    let first = true;\n    for (const pass of this.props.passes) {\n      if (!first) {\n        swapBuffers();\n      }\n      first = false;\n      const {uniforms, model} = pass.props;\n      if (uniforms) {\n        model.setUniforms(uniforms);\n      }\n      // swapBuffers();\n      model.draw({\n        uniforms: {\n          texture: inputBuffer,\n          texSize: [inputBuffer.width, inputBuffer.height]\n        },\n        parameters: {\n          depthWrite: false,\n          depthTest: false\n        }\n      });\n    }\n  }\n}\n\nfunction normalizePasses(gl, module, id, props) {\n  if (module.filter || module.sampler) {\n    const fs = getFragmentShaderForRenderPass(module);\n    const pass = new ShaderModuleSinglePass(gl, {\n      id,\n      model: getModel(gl, module, fs, id, props),\n      uniforms: null\n    });\n    return [pass];\n  }\n\n  const passes = module.passes || [];\n  return passes.map(pass => {\n    const fs = getFragmentShaderForRenderPass(module, pass);\n    const idn = `${id}-${passes.length + 1}`;\n\n    return new ShaderModuleSinglePass(\n      gl,\n      Object.assign(\n        {\n          id: idn,\n          model: getModel(gl, module, fs, idn, props),\n          uniforms: pass.uniforms\n        },\n        props\n      )\n    );\n  });\n}\n\nfunction getModel(gl, module, fs, id, props) {\n  const model = new ClipSpace(gl, {id, fs, modules: [module]});\n\n  const uniforms = Object.assign(module.getUniforms(), module.getUniforms(props));\n\n  model.setUniforms(uniforms);\n  return model;\n}\n\nconst FILTER_FS_TEMPLATE = func => `\\\nuniform sampler2D texture;\nuniform vec2 texSize;\n\nvarying vec2 position;\nvarying vec2 coordinate;\nvarying vec2 uv;\n\nvoid main() {\n  vec2 texCoord = coordinate;\n\n  gl_FragColor = texture2D(texture, texCoord);\n  gl_FragColor = ${func}(gl_FragColor, texSize, texCoord);\n}\n`;\n\nconst SAMPLER_FS_TEMPLATE = func => `\\\nuniform sampler2D texture;\nuniform vec2 texSize;\n\nvarying vec2 position;\nvarying vec2 coordinate;\nvarying vec2 uv;\n\nvoid main() {\n  vec2 texCoord = coordinate;\n\n  gl_FragColor = ${func}(texture, texSize, texCoord);\n}\n`;\n\nfunction getFragmentShaderForRenderPass(module, pass = module) {\n  if (pass.filter) {\n    const func = typeof pass.filter === 'string' ? pass.filter : `${module.name}_filterColor`;\n    return FILTER_FS_TEMPLATE(func);\n  }\n\n  if (pass.sampler) {\n    const func = typeof pass.sampler === 'string' ? pass.sampler : `${module.name}_sampleColor`;\n    return SAMPLER_FS_TEMPLATE(func);\n  }\n\n  // console.error(`${module.name} no fragment shader generated`);\n  return null;\n}\n"],"file":"shader-module-pass.js"}