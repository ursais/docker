{"version":3,"sources":["../../../src/lib/animation-loop.js"],"names":["isWebGL","createGLContext","instrumentGLContext","resizeGLContext","resetParameters","requestAnimationFrame","cancelAnimationFrame","getPageLoadPromise","Query","lumaStats","Framebuffer","log","assert","statIdCounter","AnimationLoop","props","onCreateContext","opts","onAddHTML","onInitialize","onRender","onFinalize","gl","glOptions","debug","createFramebuffer","autoResizeViewport","autoResizeDrawingBuffer","stats","get","useDevicePixels","deprecated","useDevicePixelRatio","needsRedraw","timeline","cpuTime","gpuTime","frameRate","_initialized","_running","_animationFrameId","_nextFramePromise","_resolveNextFrame","_cpuStartTime","setProps","start","bind","stop","_onMousemove","_onMouseleave","_setDisplay","reason","then","_createWebGLContext","_createFramebuffer","_startEventHandling","_initializeCallbackData","_updateCallbackData","_resizeCanvasDrawingBuffer","_resizeViewport","_gpuTimeQuery","isSupported","animationProps","appContext","_addCallbackData","_startLoop","_beginTimers","_setupFrame","_renderFrame","_clearNeedsRedraw","offScreen","commit","_endTimers","_finalizeCallbackData","setNeedsRedraw","Promise","resolve","waitForRender","canvas","toDataURL","id","defaultValue","element","document","getElementById","Number","value","removed","renderFrame","redraw","_requestAnimationFrame","display","animationLoop","renderFrameCallback","_onSetupFrame","_resizeFramebuffer","framebuffer","startTime","Date","now","engineTime","tick","tock","time","_timeline","_loop","_animationLoop","_mousePosition","_getSizeAndAspect","width","height","aspect","update","Math","floor","getTime","_offScreen","Object","assign","OffscreenCanvas","Error","_createInfoDiv","wrapperDiv","createElement","body","appendChild","style","position","div","left","bottom","background","html","innerHTML","drawingBufferWidth","drawingBufferHeight","clientHeight","clientWidth","viewport","resize","timeEnd","timeStart","isResultAvailable","isTimerDisjoint","addTime","getTimerMilliseconds","beginTimeElapsedQuery","end","addEventListener","e","offsetX","offsetY"],"mappings":"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","sourcesContent":["/* global OffscreenCanvas */\nimport {\n  isWebGL,\n  createGLContext,\n  instrumentGLContext,\n  resizeGLContext,\n  resetParameters,\n  requestAnimationFrame,\n  cancelAnimationFrame,\n  getPageLoadPromise,\n  Query,\n  lumaStats,\n  // TODO - remove dependency on framebuffer (bundle size impact)\n  Framebuffer\n} from '@luma.gl/webgl';\n\nimport {log, assert} from '../utils';\n\nlet statIdCounter = 0;\n\nexport default class AnimationLoop {\n  /*\n   * @param {HTMLCanvasElement} canvas - if provided, width and height will be passed to context\n   */\n  constructor(props = {}) {\n    const {\n      onCreateContext = opts => createGLContext(opts),\n      onAddHTML = null,\n      onInitialize = () => {},\n      onRender = () => {},\n      onFinalize = () => {},\n\n      gl = null,\n      glOptions = {},\n      debug = false,\n\n      createFramebuffer = false,\n\n      // view parameters\n      autoResizeViewport = true,\n      autoResizeDrawingBuffer = true,\n      stats = lumaStats.get(`animation-loop-${statIdCounter++}`)\n    } = props;\n\n    let {useDevicePixels = true} = props;\n\n    if ('useDevicePixelRatio' in props) {\n      log.deprecated('useDevicePixelRatio', 'useDevicePixels')();\n      useDevicePixels = props.useDevicePixelRatio;\n    }\n\n    this.props = {\n      onCreateContext,\n      onAddHTML,\n      onInitialize,\n      onRender,\n      onFinalize,\n\n      gl,\n      glOptions,\n      debug,\n      createFramebuffer\n    };\n\n    // state\n    this.gl = gl;\n    this.needsRedraw = null;\n    this.timeline = null;\n    this.stats = stats;\n    this.cpuTime = this.stats.get('CPU Time');\n    this.gpuTime = this.stats.get('GPU Time');\n    this.frameRate = this.stats.get('Frame Rate');\n\n    this._initialized = false;\n    this._running = false;\n    this._animationFrameId = null;\n    this._nextFramePromise = null;\n    this._resolveNextFrame = null;\n    this._cpuStartTime = 0;\n\n    this.setProps({\n      autoResizeViewport,\n      autoResizeDrawingBuffer,\n      useDevicePixels\n    });\n\n    // Bind methods\n    this.start = this.start.bind(this);\n    this.stop = this.stop.bind(this);\n\n    this._onMousemove = this._onMousemove.bind(this);\n    this._onMouseleave = this._onMouseleave.bind(this);\n  }\n\n  delete() {\n    this.stop();\n    this._setDisplay(null);\n  }\n\n  setNeedsRedraw(reason) {\n    assert(typeof reason === 'string');\n    this.needsRedraw = this.needsRedraw || reason;\n    return this;\n  }\n\n  setProps(props) {\n    if ('autoResizeViewport' in props) {\n      this.autoResizeViewport = props.autoResizeViewport;\n    }\n    if ('autoResizeDrawingBuffer' in props) {\n      this.autoResizeDrawingBuffer = props.autoResizeDrawingBuffer;\n    }\n    if ('useDevicePixels' in props) {\n      this.useDevicePixels = props.useDevicePixels;\n    }\n    return this;\n  }\n\n  // Starts a render loop if not already running\n  // @param {Object} context - contains frame specific info (E.g. tick, width, height, etc)\n  start(opts = {}) {\n    if (this._running) {\n      return this;\n    }\n    this._running = true;\n    // console.debug(`Starting ${this.constructor.name}`);\n    // Wait for start promise before rendering frame\n    getPageLoadPromise()\n      .then(() => {\n        if (!this._running || this._initialized) {\n          return null;\n        }\n\n        // Create the WebGL context\n        this._createWebGLContext(opts);\n        this._createFramebuffer();\n        this._startEventHandling();\n\n        // Initialize the callback data\n        this._initializeCallbackData();\n        this._updateCallbackData();\n\n        // Default viewport setup, in case onInitialize wants to render\n        this._resizeCanvasDrawingBuffer();\n        this._resizeViewport();\n\n        this._gpuTimeQuery = Query.isSupported(this.gl, ['timers']) ? new Query(this.gl) : null;\n\n        this._initialized = true;\n\n        // Note: onIntialize can return a promise (in case it needs to load resources)\n        return this.onInitialize(this.animationProps);\n      })\n      .then(appContext => {\n        if (this._running) {\n          this._addCallbackData(appContext || {});\n          if (appContext !== false) {\n            this._startLoop();\n          }\n        }\n      });\n    return this;\n  }\n\n  // Redraw now\n  redraw() {\n    this._beginTimers();\n\n    this._setupFrame();\n    this._updateCallbackData();\n\n    this._renderFrame(this.animationProps);\n\n    // clear needsRedraw flag\n    this._clearNeedsRedraw();\n\n    // https://developer.mozilla.org/en-US/docs/Web/API/WebGLRenderingContext/commit\n    // Chrome's offscreen canvas does not require gl.commit\n    if (this.offScreen && this.gl.commit) {\n      this.gl.commit();\n    }\n\n    if (this._resolveNextFrame) {\n      this._resolveNextFrame(this);\n      this._nextFramePromise = null;\n      this._resolveNextFrame = null;\n    }\n\n    this._endTimers();\n\n    return this;\n  }\n\n  // Stops a render loop if already running, finalizing\n  stop() {\n    // console.debug(`Stopping ${this.constructor.name}`);\n    if (this._running) {\n      this._finalizeCallbackData();\n      cancelAnimationFrame(this._animationFrameId);\n      this._nextFramePromise = null;\n      this._resolveNextFrame = null;\n      this._animationFrameId = null;\n      this._running = false;\n    }\n    return this;\n  }\n\n  attachTimeline(timeline) {\n    this.timeline = timeline;\n\n    return this.timeline;\n  }\n\n  detachTimeline() {\n    this.timeline = null;\n  }\n\n  waitForRender() {\n    this.setNeedsRedraw('waitForRender');\n\n    if (!this._nextFramePromise) {\n      this._nextFramePromise = new Promise(resolve => {\n        this._resolveNextFrame = resolve;\n      });\n    }\n    return this._nextFramePromise;\n  }\n\n  async toDataURL() {\n    this.setNeedsRedraw('toDataURL');\n\n    await this.waitForRender();\n\n    return this.gl.canvas.toDataURL();\n  }\n\n  onCreateContext(...args) {\n    return this.props.onCreateContext(...args);\n  }\n\n  onInitialize(...args) {\n    return this.props.onInitialize(...args);\n  }\n\n  onRender(...args) {\n    return this.props.onRender(...args);\n  }\n\n  onFinalize(...args) {\n    return this.props.onFinalize(...args);\n  }\n\n  // DEPRECATED/REMOVED METHODS\n\n  getHTMLControlValue(id, defaultValue = 1) {\n    const element = document.getElementById(id);\n    return element ? Number(element.value) : defaultValue;\n  }\n\n  // Update parameters\n  setViewParameters() {\n    log.removed('AnimationLoop.setViewParameters', 'AnimationLoop.setProps')();\n    return this;\n  }\n\n  // PRIVATE METHODS\n\n  _startLoop() {\n    const renderFrame = () => {\n      if (!this._running) {\n        return;\n      }\n      this.redraw();\n      this._animationFrameId = this._requestAnimationFrame(renderFrame);\n    };\n\n    // cancel any pending renders to ensure only one loop can ever run\n    cancelAnimationFrame(this._animationFrameId);\n    this._animationFrameId = this._requestAnimationFrame(renderFrame);\n  }\n\n  // PRIVATE METHODS\n\n  _setDisplay(display) {\n    if (this.display) {\n      this.display.delete();\n      this.display.animationLoop = null;\n    }\n\n    // store animation loop on the display\n    if (display) {\n      display.animationLoop = this;\n    }\n\n    this.display = display;\n  }\n\n  _requestAnimationFrame(renderFrameCallback) {\n    // E.g. VR display has a separate animation frame to sync with headset\n    if (this.display && this.display.requestAnimationFrame(renderFrameCallback)) {\n      return;\n    }\n\n    requestAnimationFrame(renderFrameCallback);\n  }\n\n  // Called on each frame, can be overridden to call onRender multiple times\n  // to support e.g. stereoscopic rendering\n  _renderFrame(...args) {\n    // Allow e.g. VR display to render multiple frames.\n    if (this.display) {\n      this.display._renderFrame(...args);\n      return;\n    }\n\n    // call callback\n    this.onRender(...args);\n    // end callback\n  }\n\n  _clearNeedsRedraw() {\n    this.needsRedraw = null;\n  }\n\n  _setupFrame() {\n    if (this._onSetupFrame) {\n      // call callback\n      this._onSetupFrame(this.animationProps);\n      // end callback\n    } else {\n      this._resizeCanvasDrawingBuffer();\n      this._resizeViewport();\n      this._resizeFramebuffer();\n    }\n  }\n\n  // Initialize the  object that will be passed to app callbacks\n  _initializeCallbackData() {\n    this.animationProps = {\n      gl: this.gl,\n\n      stop: this.stop,\n      canvas: this.gl.canvas,\n      framebuffer: this.framebuffer,\n\n      // Initial values\n      useDevicePixels: this.useDevicePixels,\n      needsRedraw: null,\n\n      // Animation props\n      startTime: Date.now(),\n      engineTime: 0,\n      tick: 0,\n      tock: 0,\n\n      // Timeline time for back compatibility\n      time: 0,\n\n      // Experimental\n      _timeline: this.timeline,\n      _loop: this,\n      _animationLoop: this,\n      _mousePosition: null // Event props\n    };\n  }\n\n  // Update the context object that will be passed to app callbacks\n  _updateCallbackData() {\n    const {width, height, aspect} = this._getSizeAndAspect();\n    if (width !== this.animationProps.width || height !== this.animationProps.height) {\n      this.setNeedsRedraw('drawing buffer resized');\n    }\n    if (aspect !== this.animationProps.aspect) {\n      this.setNeedsRedraw('drawing buffer aspect changed');\n    }\n\n    this.animationProps.width = width;\n    this.animationProps.height = height;\n    this.animationProps.aspect = aspect;\n\n    this.animationProps.needsRedraw = this.needsRedraw;\n\n    // Update time properties\n    this.animationProps.engineTime = Date.now() - this.animationProps.startTime;\n\n    if (this.timeline) {\n      this.timeline.update(this.animationProps.engineTime);\n    }\n\n    this.animationProps.tick = Math.floor((this.animationProps.time / 1000) * 60);\n    this.animationProps.tock++;\n\n    // For back compatibility\n    this.animationProps.time = this.timeline\n      ? this.timeline.getTime()\n      : this.animationProps.engineTime;\n\n    // experimental\n    this.animationProps._offScreen = this.offScreen;\n  }\n\n  _finalizeCallbackData() {\n    // call callback\n    this.onFinalize(this.animationProps);\n    // end callback\n  }\n\n  // Add application's data to the app context object\n  _addCallbackData(appContext) {\n    if (typeof appContext === 'object' && appContext !== null) {\n      this.animationProps = Object.assign({}, this.animationProps, appContext);\n    }\n  }\n\n  // Either uses supplied or existing context, or calls provided callback to create one\n  _createWebGLContext(opts) {\n    this.offScreen =\n      opts.canvas &&\n      typeof OffscreenCanvas !== 'undefined' &&\n      opts.canvas instanceof OffscreenCanvas;\n\n    // Create the WebGL context if necessary\n    opts = Object.assign({}, opts, this.props.glOptions);\n    this.gl = this.props.gl ? instrumentGLContext(this.props.gl, opts) : this.onCreateContext(opts);\n\n    if (!isWebGL(this.gl)) {\n      throw new Error('AnimationLoop.onCreateContext - illegal context returned');\n    }\n\n    // Reset the WebGL context.\n    resetParameters(this.gl);\n\n    this._createInfoDiv();\n  }\n\n  _createInfoDiv() {\n    if (this.gl.canvas && this.props.onAddHTML) {\n      /* global document */\n      const wrapperDiv = document.createElement('div');\n      document.body.appendChild(wrapperDiv);\n      wrapperDiv.style.position = 'relative';\n      const div = document.createElement('div');\n      div.style.position = 'absolute';\n      div.style.left = '10px';\n      div.style.bottom = '10px';\n      div.style.width = '300px';\n      div.style.background = 'white';\n      wrapperDiv.appendChild(this.gl.canvas);\n      wrapperDiv.appendChild(div);\n      const html = this.props.onAddHTML(div);\n      if (html) {\n        div.innerHTML = html;\n      }\n    }\n  }\n\n  _getSizeAndAspect() {\n    // https://webglfundamentals.org/webgl/lessons/webgl-resizing-the-canvas.html\n    const width = this.gl.drawingBufferWidth;\n    const height = this.gl.drawingBufferHeight;\n\n    // https://webglfundamentals.org/webgl/lessons/webgl-anti-patterns.html\n    let aspect = 1;\n    const {canvas} = this.gl;\n\n    if (canvas && canvas.clientHeight) {\n      aspect = canvas.clientWidth / canvas.clientHeight;\n    } else if (width > 0 && height > 0) {\n      aspect = width / height;\n    }\n\n    return {width, height, aspect};\n  }\n\n  // Default viewport setup\n  _resizeViewport() {\n    if (this.autoResizeViewport) {\n      this.gl.viewport(0, 0, this.gl.drawingBufferWidth, this.gl.drawingBufferHeight);\n    }\n  }\n\n  // Resize the render buffer of the canvas to match canvas client size\n  // Optionally multiplying with devicePixel ratio\n  _resizeCanvasDrawingBuffer() {\n    if (this.autoResizeDrawingBuffer) {\n      resizeGLContext(this.gl, {useDevicePixels: this.useDevicePixels});\n    }\n  }\n\n  // TBD - deprecated?\n  _createFramebuffer() {\n    // Setup default framebuffer\n    if (this.props.createFramebuffer) {\n      this.framebuffer = new Framebuffer(this.gl);\n    }\n  }\n\n  _resizeFramebuffer() {\n    if (this.framebuffer) {\n      this.framebuffer.resize({\n        width: this.gl.drawingBufferWidth,\n        height: this.gl.drawingBufferHeight\n      });\n    }\n  }\n\n  _beginTimers() {\n    this.frameRate.timeEnd();\n    this.frameRate.timeStart();\n\n    // Check if timer for last frame has completed.\n    // GPU timer results are never available in the same\n    // frame they are captured.\n    if (\n      this._gpuTimeQuery &&\n      this._gpuTimeQuery.isResultAvailable() &&\n      !this._gpuTimeQuery.isTimerDisjoint()\n    ) {\n      this.stats.get('GPU Time').addTime(this._gpuTimeQuery.getTimerMilliseconds());\n    }\n\n    if (this._gpuTimeQuery) {\n      // GPU time query start\n      this._gpuTimeQuery.beginTimeElapsedQuery();\n    }\n\n    this.cpuTime.timeStart();\n  }\n\n  _endTimers() {\n    this.cpuTime.timeEnd();\n\n    if (this._gpuTimeQuery) {\n      // GPU time query end. Results will be available on next frame.\n      this._gpuTimeQuery.end();\n    }\n  }\n\n  // Event handling\n\n  _startEventHandling() {\n    const {canvas} = this.gl;\n    if (canvas) {\n      canvas.addEventListener('mousemove', this._onMousemove);\n      canvas.addEventListener('mouseleave', this._onMouseleave);\n    }\n  }\n\n  _onMousemove(e) {\n    this.animationProps._mousePosition = [e.offsetX, e.offsetY];\n  }\n  _onMouseleave(e) {\n    this.animationProps._mousePosition = null;\n  }\n}\n"],"file":"animation-loop.js"}