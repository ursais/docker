{"ast":null,"code":"import _Object$keys from \"@babel/runtime-corejs3/core-js-stable/object/keys\";import _bindInstanceProperty from \"@babel/runtime-corejs3/core-js-stable/instance/bind\";import _setInterval from \"@babel/runtime-corejs3/core-js-stable/set-interval\";import _Object$values from \"@babel/runtime-corejs3/core-js-stable/object/values\";import _someInstanceProperty from \"@babel/runtime-corejs3/core-js-stable/instance/some\";import _indexOfInstanceProperty from \"@babel/runtime-corejs3/core-js-stable/instance/index-of\";(function () {var enterModule = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.enterModule : undefined;enterModule && enterModule(module);})();var __signature__ = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.default.signature : function (a) {return a;}; /**\n * Licensed to the Apache Software Foundation (ASF) under one\n * or more contributor license agreements.  See the NOTICE file\n * distributed with this work for additional information\n * regarding copyright ownership.  The ASF licenses this file\n * to you under the Apache License, Version 2.0 (the\n * \"License\"); you may not use this file except in compliance\n * with the License.  You may obtain a copy of the License at\n *\n *   http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing,\n * software distributed under the License is distributed on an\n * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n * KIND, either express or implied.  See the License for the\n * specific language governing permissions and limitations\n * under the License.\n */\nimport React from 'react';\nimport PropTypes from 'prop-types';\nimport { bindActionCreators } from 'redux';\nimport { connect } from 'react-redux';\nimport { SupersetClient } from '@superset-ui/core';\n\nimport * as Actions from '../actions/sqlLab';\n\nconst QUERY_UPDATE_FREQ = 2000;\nconst QUERY_UPDATE_BUFFER_MS = 5000;\nconst MAX_QUERY_AGE_TO_POLL = 21600000;\nconst QUERY_TIMEOUT_LIMIT = 10000;\n\nclass QueryAutoRefresh extends React.PureComponent {\n  constructor(props) {\n    super(props);\n    this.state = {\n      offline: props.offline };\n\n  }\n\n  UNSAFE_componentWillMount() {\n    this.startTimer();\n  }\n\n  componentDidUpdate(prevProps) {\n    if (prevProps.offline !== this.state.offline) {\n      this.props.actions.setUserOffline(this.state.offline);\n    }\n  }\n\n  componentWillUnmount() {\n    this.stopTimer();\n  }\n\n  shouldCheckForQueries() {var _context2;\n    // if there are started or running queries, this method should return true\n    const { queries } = this.props;\n    const now = new Date().getTime();\n    const isQueryRunning = q => {var _context;return (\n        _indexOfInstanceProperty(_context = ['running', 'started', 'pending', 'fetching']).call(_context, q.state) >= 0);};\n\n    return _someInstanceProperty(_context2 = _Object$values(queries)).call(_context2,\n    q => isQueryRunning(q) && now - q.startDttm < MAX_QUERY_AGE_TO_POLL);\n\n  }\n\n  startTimer() {\n    if (!this.timer) {var _context3;\n      this.timer = _setInterval(_bindInstanceProperty(_context3 = this.stopwatch).call(_context3, this), QUERY_UPDATE_FREQ);\n    }\n  }\n\n  stopTimer() {\n    clearInterval(this.timer);\n    this.timer = null;\n  }\n\n  stopwatch() {\n    // only poll /superset/queries/ if there are started or running queries\n    if (this.shouldCheckForQueries()) {\n      SupersetClient.get({\n        endpoint: `/superset/queries/${\n        this.props.queriesLastUpdate - QUERY_UPDATE_BUFFER_MS\n        }`,\n        timeout: QUERY_TIMEOUT_LIMIT }).\n\n      then(({ json }) => {\n        if (_Object$keys(json).length > 0) {\n          this.props.actions.refreshQueries(json);\n        }\n        this.setState({ offline: false });\n      }).\n      catch(() => {\n        this.setState({ offline: true });\n      });\n    } else {\n      this.setState({ offline: false });\n    }\n  }\n\n  render() {\n    return null;\n  } // @ts-ignore\n  __reactstandin__regenerateByEval(key, code) {// @ts-ignore\n    this[key] = eval(code);}}QueryAutoRefresh.propTypes = {\n  offline: PropTypes.bool.isRequired,\n  queries: PropTypes.object.isRequired,\n  actions: PropTypes.object.isRequired,\n  queriesLastUpdate: PropTypes.number.isRequired };\n\n\nfunction mapStateToProps({ sqlLab }) {\n  return {\n    offline: sqlLab.offline,\n    queries: sqlLab.queries,\n    queriesLastUpdate: sqlLab.queriesLastUpdate };\n\n}\n\nfunction mapDispatchToProps(dispatch) {\n  return {\n    actions: bindActionCreators(Actions, dispatch) };\n\n}const _default =\n\nconnect(mapStateToProps, mapDispatchToProps)(QueryAutoRefresh);export default _default;;(function () {var reactHotLoader = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.default : undefined;if (!reactHotLoader) {return;}reactHotLoader.register(QUERY_UPDATE_FREQ, \"QUERY_UPDATE_FREQ\", \"/app/superset-frontend/src/SqlLab/components/QueryAutoRefresh.jsx\");reactHotLoader.register(QUERY_UPDATE_BUFFER_MS, \"QUERY_UPDATE_BUFFER_MS\", \"/app/superset-frontend/src/SqlLab/components/QueryAutoRefresh.jsx\");reactHotLoader.register(MAX_QUERY_AGE_TO_POLL, \"MAX_QUERY_AGE_TO_POLL\", \"/app/superset-frontend/src/SqlLab/components/QueryAutoRefresh.jsx\");reactHotLoader.register(QUERY_TIMEOUT_LIMIT, \"QUERY_TIMEOUT_LIMIT\", \"/app/superset-frontend/src/SqlLab/components/QueryAutoRefresh.jsx\");reactHotLoader.register(QueryAutoRefresh, \"QueryAutoRefresh\", \"/app/superset-frontend/src/SqlLab/components/QueryAutoRefresh.jsx\");reactHotLoader.register(mapStateToProps, \"mapStateToProps\", \"/app/superset-frontend/src/SqlLab/components/QueryAutoRefresh.jsx\");reactHotLoader.register(mapDispatchToProps, \"mapDispatchToProps\", \"/app/superset-frontend/src/SqlLab/components/QueryAutoRefresh.jsx\");reactHotLoader.register(_default, \"default\", \"/app/superset-frontend/src/SqlLab/components/QueryAutoRefresh.jsx\");})();;(function () {var leaveModule = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.leaveModule : undefined;leaveModule && leaveModule(module);})();","map":{"version":3,"sources":["/app/superset-frontend/src/SqlLab/components/QueryAutoRefresh.jsx"],"names":["React","PropTypes","bindActionCreators","connect","SupersetClient","Actions","QUERY_UPDATE_FREQ","QUERY_UPDATE_BUFFER_MS","MAX_QUERY_AGE_TO_POLL","QUERY_TIMEOUT_LIMIT","QueryAutoRefresh","PureComponent","constructor","props","state","offline","UNSAFE_componentWillMount","startTimer","componentDidUpdate","prevProps","actions","setUserOffline","componentWillUnmount","stopTimer","shouldCheckForQueries","queries","now","Date","getTime","isQueryRunning","q","startDttm","timer","stopwatch","clearInterval","get","endpoint","queriesLastUpdate","timeout","then","json","length","refreshQueries","setState","catch","render","propTypes","bool","isRequired","object","number","mapStateToProps","sqlLab","mapDispatchToProps","dispatch"],"mappings":"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","sourcesContent":["/**\n * Licensed to the Apache Software Foundation (ASF) under one\n * or more contributor license agreements.  See the NOTICE file\n * distributed with this work for additional information\n * regarding copyright ownership.  The ASF licenses this file\n * to you under the Apache License, Version 2.0 (the\n * \"License\"); you may not use this file except in compliance\n * with the License.  You may obtain a copy of the License at\n *\n *   http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing,\n * software distributed under the License is distributed on an\n * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n * KIND, either express or implied.  See the License for the\n * specific language governing permissions and limitations\n * under the License.\n */\nimport React from 'react';\nimport PropTypes from 'prop-types';\nimport { bindActionCreators } from 'redux';\nimport { connect } from 'react-redux';\nimport { SupersetClient } from '@superset-ui/core';\n\nimport * as Actions from '../actions/sqlLab';\n\nconst QUERY_UPDATE_FREQ = 2000;\nconst QUERY_UPDATE_BUFFER_MS = 5000;\nconst MAX_QUERY_AGE_TO_POLL = 21600000;\nconst QUERY_TIMEOUT_LIMIT = 10000;\n\nclass QueryAutoRefresh extends React.PureComponent {\n  constructor(props) {\n    super(props);\n    this.state = {\n      offline: props.offline,\n    };\n  }\n\n  UNSAFE_componentWillMount() {\n    this.startTimer();\n  }\n\n  componentDidUpdate(prevProps) {\n    if (prevProps.offline !== this.state.offline) {\n      this.props.actions.setUserOffline(this.state.offline);\n    }\n  }\n\n  componentWillUnmount() {\n    this.stopTimer();\n  }\n\n  shouldCheckForQueries() {\n    // if there are started or running queries, this method should return true\n    const { queries } = this.props;\n    const now = new Date().getTime();\n    const isQueryRunning = q =>\n      ['running', 'started', 'pending', 'fetching'].indexOf(q.state) >= 0;\n\n    return Object.values(queries).some(\n      q => isQueryRunning(q) && now - q.startDttm < MAX_QUERY_AGE_TO_POLL,\n    );\n  }\n\n  startTimer() {\n    if (!this.timer) {\n      this.timer = setInterval(this.stopwatch.bind(this), QUERY_UPDATE_FREQ);\n    }\n  }\n\n  stopTimer() {\n    clearInterval(this.timer);\n    this.timer = null;\n  }\n\n  stopwatch() {\n    // only poll /superset/queries/ if there are started or running queries\n    if (this.shouldCheckForQueries()) {\n      SupersetClient.get({\n        endpoint: `/superset/queries/${\n          this.props.queriesLastUpdate - QUERY_UPDATE_BUFFER_MS\n        }`,\n        timeout: QUERY_TIMEOUT_LIMIT,\n      })\n        .then(({ json }) => {\n          if (Object.keys(json).length > 0) {\n            this.props.actions.refreshQueries(json);\n          }\n          this.setState({ offline: false });\n        })\n        .catch(() => {\n          this.setState({ offline: true });\n        });\n    } else {\n      this.setState({ offline: false });\n    }\n  }\n\n  render() {\n    return null;\n  }\n}\nQueryAutoRefresh.propTypes = {\n  offline: PropTypes.bool.isRequired,\n  queries: PropTypes.object.isRequired,\n  actions: PropTypes.object.isRequired,\n  queriesLastUpdate: PropTypes.number.isRequired,\n};\n\nfunction mapStateToProps({ sqlLab }) {\n  return {\n    offline: sqlLab.offline,\n    queries: sqlLab.queries,\n    queriesLastUpdate: sqlLab.queriesLastUpdate,\n  };\n}\n\nfunction mapDispatchToProps(dispatch) {\n  return {\n    actions: bindActionCreators(Actions, dispatch),\n  };\n}\n\nexport default connect(mapStateToProps, mapDispatchToProps)(QueryAutoRefresh);\n"]},"metadata":{},"sourceType":"module"}