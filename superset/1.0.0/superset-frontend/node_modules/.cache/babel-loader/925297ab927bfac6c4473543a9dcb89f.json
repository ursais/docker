{"ast":null,"code":"import \"core-js/modules/web.dom-collections.iterator.js\";import _extends from \"@babel/runtime-corejs3/helpers/extends\";import _filterInstanceProperty from \"@babel/runtime-corejs3/core-js-stable/instance/filter\";import _mapInstanceProperty from \"@babel/runtime-corejs3/core-js-stable/instance/map\";import _includesInstanceProperty from \"@babel/runtime-corejs3/core-js-stable/instance/includes\";import _Object$keys from \"@babel/runtime-corejs3/core-js-stable/object/keys\";import _bindInstanceProperty from \"@babel/runtime-corejs3/core-js-stable/instance/bind\";(function () {var enterModule = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.enterModule : undefined;enterModule && enterModule(module);})();var __signature__ = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.default.signature : function (a) {return a;}; /**\n * Licensed to the Apache Software Foundation (ASF) under one\n * or more contributor license agreements.  See the NOTICE file\n * distributed with this work for additional information\n * regarding copyright ownership.  The ASF licenses this file\n * to you under the Apache License, Version 2.0 (the\n * \"License\"); you may not use this file except in compliance\n * with the License.  You may obtain a copy of the License at\n *\n *   http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing,\n * software distributed under the License is distributed on an\n * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n * KIND, either express or implied.  See the License for the\n * specific language governing permissions and limitations\n * under the License.\n */\nimport React from 'react';\nimport PropTypes from 'prop-types';\nimport { List } from 'src/common/components';\nimport { connect } from 'react-redux';\nimport { t, withTheme } from '@superset-ui/core';\nimport { InfoTooltipWithTrigger } from '@superset-ui/chart-controls';\nimport Popover from 'src/components/Popover';\nimport AsyncEsmComponent from 'src/components/AsyncEsmComponent';\nimport { getChartKey } from 'src/explore/exploreUtils';\nimport { runAnnotationQuery } from 'src/chart/chartAction';\nimport CustomListItem from 'src/explore/components/controls/CustomListItem';import { jsx as ___EmotionJSX } from \"@emotion/react\";\n\nconst AnnotationLayer = AsyncEsmComponent(\n() => import('./AnnotationLayer'),\n// size of overlay inner content\n() => ___EmotionJSX(\"div\", { style: { width: 450, height: 368 } }));\n\n\nconst propTypes = {\n  colorScheme: PropTypes.string.isRequired,\n  annotationError: PropTypes.object,\n  annotationQuery: PropTypes.object,\n  vizType: PropTypes.string,\n\n  validationErrors: PropTypes.array,\n  name: PropTypes.string.isRequired,\n  actions: PropTypes.object,\n  value: PropTypes.arrayOf(PropTypes.object),\n  onChange: PropTypes.func,\n  refreshAnnotationData: PropTypes.func };\n\n\nconst defaultProps = {\n  vizType: '',\n  value: [],\n  annotationError: {},\n  annotationQuery: {},\n  onChange: () => {} };\n\n\nclass AnnotationLayerControl extends React.PureComponent {\n  constructor(props) {var _context, _context2, _context3, _context4;\n    super(props);\n    this.state = {\n      popoverVisible: {},\n      addedAnnotationIndex: null,\n      popoverClear: false };\n\n    this.addAnnotationLayer = _bindInstanceProperty(_context = this.addAnnotationLayer).call(_context, this);\n    this.removeAnnotationLayer = _bindInstanceProperty(_context2 = this.removeAnnotationLayer).call(_context2, this);\n    this.handleVisibleChange = _bindInstanceProperty(_context3 = this.handleVisibleChange).call(_context3, this);\n    this.handlePopoverClear = _bindInstanceProperty(_context4 = this.handlePopoverClear).call(_context4, this);\n  }\n\n  componentDidMount() {\n    // preload the AnotationLayer component and dependent libraries i.e. mathjs\n    AnnotationLayer.preload();\n  }\n\n  UNSAFE_componentWillReceiveProps(nextProps) {\n    const { name, annotationError, validationErrors, value } = nextProps;\n    if (_Object$keys(annotationError).length && !validationErrors.length) {\n      this.props.actions.setControlValue(\n      name,\n      value,\n      _Object$keys(annotationError));\n\n    }\n    if (!_Object$keys(annotationError).length && validationErrors.length) {\n      this.props.actions.setControlValue(name, value, []);\n    }\n  }\n\n  addAnnotationLayer(originalAnnotation, newAnnotation) {\n    let annotations = this.props.value;\n    if (_includesInstanceProperty(annotations).call(annotations, originalAnnotation)) {\n      annotations = _mapInstanceProperty(annotations).call(annotations, (anno) =>\n      anno === originalAnnotation ? newAnnotation : anno);\n\n    } else {\n      annotations = [...annotations, newAnnotation];\n      this.setState({ addedAnnotationIndex: annotations.length - 1 });\n    }\n\n    this.props.refreshAnnotationData(newAnnotation);\n    this.props.onChange(annotations);\n  }\n\n  handleVisibleChange(visible, popoverKey) {\n    if (!this.state.popoverClear) {\n      this.setState(prevState => ({\n        popoverVisible: { ...prevState.popoverVisible, [popoverKey]: visible } }));\n\n    } else {\n      this.handlePopoverClear(false);\n    }\n  }\n\n  handlePopoverClear(popoverClear) {\n    this.setState({\n      popoverClear });\n\n  }\n\n  removeAnnotationLayer(annotation) {var _context5;\n    const annotations = _filterInstanceProperty(_context5 = this.props.value).call(_context5, anno => anno !== annotation);\n    this.props.onChange(annotations);\n  }\n\n  renderPopover(popoverKey, annotation, error) {\n    const id = (annotation == null ? void 0 : annotation.name) || '_new';\n\n    return (\n      ___EmotionJSX(\"div\", { id: `annotation-pop-${id}`, \"data-test\": \"popover-content\" },\n      ___EmotionJSX(AnnotationLayer, _extends({},\n      annotation, {\n        error: error,\n        colorScheme: this.props.colorScheme,\n        vizType: this.props.vizType,\n        addAnnotationLayer: (newAnnotation) =>\n        this.addAnnotationLayer(annotation, newAnnotation),\n\n        removeAnnotationLayer: () => this.removeAnnotationLayer(annotation),\n        close: () => {\n          this.handleVisibleChange(false, popoverKey);\n          this.setState({ addedAnnotationIndex: null });\n        },\n        onPopoverClear: this.handlePopoverClear }))));\n\n\n\n  }\n\n  renderInfo(anno) {\n    const { annotationError, annotationQuery } = this.props;\n    if (annotationQuery[anno.name]) {\n      return (\n        ___EmotionJSX(\"i\", { className: \"fa fa-refresh\", style: { color: 'orange' }, \"aria-hidden\": true }));\n\n    }\n    if (annotationError[anno.name]) {\n      return (\n        ___EmotionJSX(InfoTooltipWithTrigger, {\n          label: \"validation-errors\",\n          bsStyle: \"danger\",\n          tooltip: annotationError[anno.name] }));\n\n\n    }\n    if (!anno.show) {\n      return ___EmotionJSX(\"span\", { style: { color: 'red' } }, \" Hidden \");\n    }\n    return '';\n  }\n\n  render() {var _context6;\n    const { addedAnnotationIndex } = this.state;\n    const addedAnnotation = this.props.value[addedAnnotationIndex];\n\n    const annotations = _mapInstanceProperty(_context6 = this.props.value).call(_context6, (anno, i) =>\n    ___EmotionJSX(Popover, {\n      key: i,\n      trigger: \"click\",\n      placement: \"right\",\n      title: t('Edit annotation layer'),\n      css: theme => ({\n        '&:hover': {\n          cursor: 'pointer',\n          backgroundColor: theme.colors.grayscale.light4 } }),\n\n\n      content: this.renderPopover(\n      i,\n      anno,\n      this.props.annotationError[anno.name]),\n\n      visible: this.state.popoverVisible[i],\n      onVisibleChange: visible => this.handleVisibleChange(visible, i) },\n\n    ___EmotionJSX(CustomListItem, { selectable: true },\n    ___EmotionJSX(\"span\", null, anno.name),\n    ___EmotionJSX(\"span\", { style: { float: 'right' } }, this.renderInfo(anno)))));\n\n\n\n\n    const addLayerPopoverKey = 'add';\n    return (\n      ___EmotionJSX(\"div\", null,\n      ___EmotionJSX(List, { bordered: true, css: theme => ({ borderRadius: theme.gridUnit }) },\n      annotations,\n      ___EmotionJSX(Popover, {\n        trigger: \"click\",\n        placement: \"right\",\n        content: this.renderPopover(addLayerPopoverKey, addedAnnotation),\n        title: t('Add annotation layer'),\n        visible: this.state.popoverVisible[addLayerPopoverKey],\n        destroyTooltipOnHide: true,\n        onVisibleChange: (visible) =>\n        this.handleVisibleChange(visible, addLayerPopoverKey) },\n\n\n      ___EmotionJSX(CustomListItem, { selectable: true },\n      ___EmotionJSX(\"i\", {\n        \"data-test\": \"add-annotation-layer-button\",\n        className: \"fa fa-plus\" }),\n      ' ', \"\\xA0 \",\n      t('Add annotation layer'))))));\n\n\n\n\n\n  } // @ts-ignore\n  __reactstandin__regenerateByEval(key, code) {// @ts-ignore\n    this[key] = eval(code);}}\nAnnotationLayerControl.propTypes = propTypes;\nAnnotationLayerControl.defaultProps = defaultProps;\n\n// Tried to hook this up through stores/control.jsx instead of using redux\n// directly, could not figure out how to get access to the color_scheme\nfunction mapStateToProps({ charts, explore }) {var _explore$controls, _explore$controls$col;\n  const chartKey = getChartKey(explore);\n  const chart = charts[chartKey] || charts[0] || {};\n\n  return {\n    // eslint-disable-next-line camelcase\n    colorScheme: (_explore$controls = explore.controls) == null ? void 0 : (_explore$controls$col = _explore$controls.color_scheme) == null ? void 0 : _explore$controls$col.value,\n    annotationError: chart.annotationError,\n    annotationQuery: chart.annotationQuery,\n    vizType: explore.controls.viz_type.value };\n\n}\n\nfunction mapDispatchToProps(dispatch) {\n  return {\n    refreshAnnotationData: (annotationLayer) =>\n    dispatch(runAnnotationQuery(annotationLayer)) };\n\n}\n\nconst themedAnnotationLayerControl = withTheme(AnnotationLayerControl);const _default =\n\nconnect(\nmapStateToProps,\nmapDispatchToProps)(\nthemedAnnotationLayerControl);export default _default;;(function () {var reactHotLoader = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.default : undefined;if (!reactHotLoader) {return;}reactHotLoader.register(AnnotationLayer, \"AnnotationLayer\", \"/app/superset-frontend/src/explore/components/controls/AnnotationLayerControl/index.jsx\");reactHotLoader.register(propTypes, \"propTypes\", \"/app/superset-frontend/src/explore/components/controls/AnnotationLayerControl/index.jsx\");reactHotLoader.register(defaultProps, \"defaultProps\", \"/app/superset-frontend/src/explore/components/controls/AnnotationLayerControl/index.jsx\");reactHotLoader.register(AnnotationLayerControl, \"AnnotationLayerControl\", \"/app/superset-frontend/src/explore/components/controls/AnnotationLayerControl/index.jsx\");reactHotLoader.register(mapStateToProps, \"mapStateToProps\", \"/app/superset-frontend/src/explore/components/controls/AnnotationLayerControl/index.jsx\");reactHotLoader.register(mapDispatchToProps, \"mapDispatchToProps\", \"/app/superset-frontend/src/explore/components/controls/AnnotationLayerControl/index.jsx\");reactHotLoader.register(themedAnnotationLayerControl, \"themedAnnotationLayerControl\", \"/app/superset-frontend/src/explore/components/controls/AnnotationLayerControl/index.jsx\");reactHotLoader.register(_default, \"default\", \"/app/superset-frontend/src/explore/components/controls/AnnotationLayerControl/index.jsx\");})();;(function () {var leaveModule = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.leaveModule : undefined;leaveModule && leaveModule(module);})();","map":{"version":3,"sources":["/app/superset-frontend/src/explore/components/controls/AnnotationLayerControl/index.jsx"],"names":["React","PropTypes","List","connect","t","withTheme","InfoTooltipWithTrigger","Popover","AsyncEsmComponent","getChartKey","runAnnotationQuery","CustomListItem","AnnotationLayer","width","height","propTypes","colorScheme","string","isRequired","annotationError","object","annotationQuery","vizType","validationErrors","array","name","actions","value","arrayOf","onChange","func","refreshAnnotationData","defaultProps","AnnotationLayerControl","PureComponent","constructor","props","state","popoverVisible","addedAnnotationIndex","popoverClear","addAnnotationLayer","removeAnnotationLayer","handleVisibleChange","handlePopoverClear","componentDidMount","preload","UNSAFE_componentWillReceiveProps","nextProps","length","setControlValue","originalAnnotation","newAnnotation","annotations","anno","setState","visible","popoverKey","prevState","annotation","renderPopover","error","id","renderInfo","color","show","render","addedAnnotation","i","theme","cursor","backgroundColor","colors","grayscale","light4","float","addLayerPopoverKey","borderRadius","gridUnit","mapStateToProps","charts","explore","chartKey","chart","controls","color_scheme","viz_type","mapDispatchToProps","dispatch","annotationLayer","themedAnnotationLayerControl"],"mappings":"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","sourcesContent":["/**\n * Licensed to the Apache Software Foundation (ASF) under one\n * or more contributor license agreements.  See the NOTICE file\n * distributed with this work for additional information\n * regarding copyright ownership.  The ASF licenses this file\n * to you under the Apache License, Version 2.0 (the\n * \"License\"); you may not use this file except in compliance\n * with the License.  You may obtain a copy of the License at\n *\n *   http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing,\n * software distributed under the License is distributed on an\n * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n * KIND, either express or implied.  See the License for the\n * specific language governing permissions and limitations\n * under the License.\n */\nimport React from 'react';\nimport PropTypes from 'prop-types';\nimport { List } from 'src/common/components';\nimport { connect } from 'react-redux';\nimport { t, withTheme } from '@superset-ui/core';\nimport { InfoTooltipWithTrigger } from '@superset-ui/chart-controls';\nimport Popover from 'src/components/Popover';\nimport AsyncEsmComponent from 'src/components/AsyncEsmComponent';\nimport { getChartKey } from 'src/explore/exploreUtils';\nimport { runAnnotationQuery } from 'src/chart/chartAction';\nimport CustomListItem from 'src/explore/components/controls/CustomListItem';\n\nconst AnnotationLayer = AsyncEsmComponent(\n  () => import('./AnnotationLayer'),\n  // size of overlay inner content\n  () => <div style={{ width: 450, height: 368 }} />,\n);\n\nconst propTypes = {\n  colorScheme: PropTypes.string.isRequired,\n  annotationError: PropTypes.object,\n  annotationQuery: PropTypes.object,\n  vizType: PropTypes.string,\n\n  validationErrors: PropTypes.array,\n  name: PropTypes.string.isRequired,\n  actions: PropTypes.object,\n  value: PropTypes.arrayOf(PropTypes.object),\n  onChange: PropTypes.func,\n  refreshAnnotationData: PropTypes.func,\n};\n\nconst defaultProps = {\n  vizType: '',\n  value: [],\n  annotationError: {},\n  annotationQuery: {},\n  onChange: () => {},\n};\n\nclass AnnotationLayerControl extends React.PureComponent {\n  constructor(props) {\n    super(props);\n    this.state = {\n      popoverVisible: {},\n      addedAnnotationIndex: null,\n      popoverClear: false,\n    };\n    this.addAnnotationLayer = this.addAnnotationLayer.bind(this);\n    this.removeAnnotationLayer = this.removeAnnotationLayer.bind(this);\n    this.handleVisibleChange = this.handleVisibleChange.bind(this);\n    this.handlePopoverClear = this.handlePopoverClear.bind(this);\n  }\n\n  componentDidMount() {\n    // preload the AnotationLayer component and dependent libraries i.e. mathjs\n    AnnotationLayer.preload();\n  }\n\n  UNSAFE_componentWillReceiveProps(nextProps) {\n    const { name, annotationError, validationErrors, value } = nextProps;\n    if (Object.keys(annotationError).length && !validationErrors.length) {\n      this.props.actions.setControlValue(\n        name,\n        value,\n        Object.keys(annotationError),\n      );\n    }\n    if (!Object.keys(annotationError).length && validationErrors.length) {\n      this.props.actions.setControlValue(name, value, []);\n    }\n  }\n\n  addAnnotationLayer(originalAnnotation, newAnnotation) {\n    let annotations = this.props.value;\n    if (annotations.includes(originalAnnotation)) {\n      annotations = annotations.map(anno =>\n        anno === originalAnnotation ? newAnnotation : anno,\n      );\n    } else {\n      annotations = [...annotations, newAnnotation];\n      this.setState({ addedAnnotationIndex: annotations.length - 1 });\n    }\n\n    this.props.refreshAnnotationData(newAnnotation);\n    this.props.onChange(annotations);\n  }\n\n  handleVisibleChange(visible, popoverKey) {\n    if (!this.state.popoverClear) {\n      this.setState(prevState => ({\n        popoverVisible: { ...prevState.popoverVisible, [popoverKey]: visible },\n      }));\n    } else {\n      this.handlePopoverClear(false);\n    }\n  }\n\n  handlePopoverClear(popoverClear) {\n    this.setState({\n      popoverClear,\n    });\n  }\n\n  removeAnnotationLayer(annotation) {\n    const annotations = this.props.value.filter(anno => anno !== annotation);\n    this.props.onChange(annotations);\n  }\n\n  renderPopover(popoverKey, annotation, error) {\n    const id = annotation?.name || '_new';\n\n    return (\n      <div id={`annotation-pop-${id}`} data-test=\"popover-content\">\n        <AnnotationLayer\n          {...annotation}\n          error={error}\n          colorScheme={this.props.colorScheme}\n          vizType={this.props.vizType}\n          addAnnotationLayer={newAnnotation =>\n            this.addAnnotationLayer(annotation, newAnnotation)\n          }\n          removeAnnotationLayer={() => this.removeAnnotationLayer(annotation)}\n          close={() => {\n            this.handleVisibleChange(false, popoverKey);\n            this.setState({ addedAnnotationIndex: null });\n          }}\n          onPopoverClear={this.handlePopoverClear}\n        />\n      </div>\n    );\n  }\n\n  renderInfo(anno) {\n    const { annotationError, annotationQuery } = this.props;\n    if (annotationQuery[anno.name]) {\n      return (\n        <i className=\"fa fa-refresh\" style={{ color: 'orange' }} aria-hidden />\n      );\n    }\n    if (annotationError[anno.name]) {\n      return (\n        <InfoTooltipWithTrigger\n          label=\"validation-errors\"\n          bsStyle=\"danger\"\n          tooltip={annotationError[anno.name]}\n        />\n      );\n    }\n    if (!anno.show) {\n      return <span style={{ color: 'red' }}> Hidden </span>;\n    }\n    return '';\n  }\n\n  render() {\n    const { addedAnnotationIndex } = this.state;\n    const addedAnnotation = this.props.value[addedAnnotationIndex];\n\n    const annotations = this.props.value.map((anno, i) => (\n      <Popover\n        key={i}\n        trigger=\"click\"\n        placement=\"right\"\n        title={t('Edit annotation layer')}\n        css={theme => ({\n          '&:hover': {\n            cursor: 'pointer',\n            backgroundColor: theme.colors.grayscale.light4,\n          },\n        })}\n        content={this.renderPopover(\n          i,\n          anno,\n          this.props.annotationError[anno.name],\n        )}\n        visible={this.state.popoverVisible[i]}\n        onVisibleChange={visible => this.handleVisibleChange(visible, i)}\n      >\n        <CustomListItem selectable>\n          <span>{anno.name}</span>\n          <span style={{ float: 'right' }}>{this.renderInfo(anno)}</span>\n        </CustomListItem>\n      </Popover>\n    ));\n\n    const addLayerPopoverKey = 'add';\n    return (\n      <div>\n        <List bordered css={theme => ({ borderRadius: theme.gridUnit })}>\n          {annotations}\n          <Popover\n            trigger=\"click\"\n            placement=\"right\"\n            content={this.renderPopover(addLayerPopoverKey, addedAnnotation)}\n            title={t('Add annotation layer')}\n            visible={this.state.popoverVisible[addLayerPopoverKey]}\n            destroyTooltipOnHide\n            onVisibleChange={visible =>\n              this.handleVisibleChange(visible, addLayerPopoverKey)\n            }\n          >\n            <CustomListItem selectable>\n              <i\n                data-test=\"add-annotation-layer-button\"\n                className=\"fa fa-plus\"\n              />{' '}\n              &nbsp; {t('Add annotation layer')}\n            </CustomListItem>\n          </Popover>\n        </List>\n      </div>\n    );\n  }\n}\n\nAnnotationLayerControl.propTypes = propTypes;\nAnnotationLayerControl.defaultProps = defaultProps;\n\n// Tried to hook this up through stores/control.jsx instead of using redux\n// directly, could not figure out how to get access to the color_scheme\nfunction mapStateToProps({ charts, explore }) {\n  const chartKey = getChartKey(explore);\n  const chart = charts[chartKey] || charts[0] || {};\n\n  return {\n    // eslint-disable-next-line camelcase\n    colorScheme: explore.controls?.color_scheme?.value,\n    annotationError: chart.annotationError,\n    annotationQuery: chart.annotationQuery,\n    vizType: explore.controls.viz_type.value,\n  };\n}\n\nfunction mapDispatchToProps(dispatch) {\n  return {\n    refreshAnnotationData: annotationLayer =>\n      dispatch(runAnnotationQuery(annotationLayer)),\n  };\n}\n\nconst themedAnnotationLayerControl = withTheme(AnnotationLayerControl);\n\nexport default connect(\n  mapStateToProps,\n  mapDispatchToProps,\n)(themedAnnotationLayerControl);\n"]},"metadata":{},"sourceType":"module"}