{"ast":null,"code":"import \"core-js/modules/web.dom-collections.iterator.js\";import _setTimeout from \"@babel/runtime-corejs3/core-js-stable/set-timeout\";(function () {var enterModule = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.enterModule : undefined;enterModule && enterModule(module);})();var __signature__ = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.default.signature : function (a) {return a;}; /**\n * Licensed to the Apache Software Foundation (ASF) under one\n * or more contributor license agreements.  See the NOTICE file\n * distributed with this work for additional information\n * regarding copyright ownership.  The ASF licenses this file\n * to you under the Apache License, Version 2.0 (the\n * \"License\"); you may not use this file except in compliance\n * with the License.  You may obtain a copy of the License at\n *\n *   http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing,\n * software distributed under the License is distributed on an\n * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n * KIND, either express or implied.  See the License for the\n * specific language governing permissions and limitations\n * under the License.\n */\nimport React, { useState, useRef, useEffect, useCallback } from 'react';\nimport Alert from 'src/components/Alert';\nimport { SupersetClient, t, styled } from '@superset-ui/core';\nimport TableView, { EmptyWrapperType } from 'src/components/TableView';\nimport StyledModal from 'src/components/Modal';\nimport Button from 'src/components/Button';\nimport { useListViewResource } from 'src/views/CRUD/hooks';\nimport { useDebouncedEffect } from 'src/explore/exploreUtils';\nimport { SLOW_DEBOUNCE } from 'src/constants';\nimport { getClientErrorObject } from 'src/utils/getClientErrorObject';\nimport Loading from 'src/components/Loading';\nimport withToasts from 'src/messageToasts/enhancers/withToasts';\nimport { Input } from 'src/common/components';\nimport { PAGE_SIZE as DATASET_PAGE_SIZE, SORT_BY as DATASET_SORT_BY } from 'src/views/CRUD/data/dataset/constants';\nimport FacePile from '../components/FacePile';import { jsx as ___EmotionJSX } from \"@emotion/react\";\nconst CONFIRM_WARNING_MESSAGE = t('Warning! Changing the dataset may break the chart if the metadata does not exist.');\nconst CHANGE_WARNING_MSG = t('Changing the dataset may break the chart if the chart relies ' +\n'on columns or metadata that does not exist in the target dataset');\nconst ConfirmModalStyled = styled.div`\n  .btn-container {\n    display: flex;\n    justify-content: flex-end;\n    padding: 0px 15px;\n    margin: 10px 0 0 0;\n  }\n\n  .confirm-modal-container {\n    margin: 9px;\n  }\n`;\nconst StyledSpan = styled.span`\n  cursor: pointer;\n  color: ${({ theme }) => theme.colors.primary.dark1};\n  &: hover {\n    color: ${({ theme }) => theme.colors.primary.dark2};\n  }\n`;\nconst ChangeDatasourceModal = ({ addDangerToast, addSuccessToast, onChange, onDatasourceSave, onHide, show }) => {\n  const [filter, setFilter] = useState(undefined);\n  const [pageIndex, setPageIndex] = useState(0);\n  const [sortBy, setSortBy] = useState(DATASET_SORT_BY);\n  const [confirmChange, setConfirmChange] = useState(false);\n  const [confirmedDataset, setConfirmedDataset] = useState();\n  const searchRef = useRef(null);\n  const { state: { loading, resourceCollection, resourceCount }, fetchData } = useListViewResource('dataset', t('dataset'), addDangerToast);\n  const selectDatasource = useCallback(datasource => {\n    setConfirmChange(true);\n    setConfirmedDataset(datasource);\n  }, []);\n  const fetchDatasetPayload = {\n    pageIndex,\n    pageSize: DATASET_PAGE_SIZE,\n    filters: [],\n    sortBy };\n\n  useDebouncedEffect(() => {\n    fetchData({\n      ...fetchDatasetPayload,\n      ...(filter && {\n        filters: [\n        {\n          id: 'table_name',\n          operator: 'ct',\n          value: filter }] }) });\n\n\n\n\n  }, SLOW_DEBOUNCE, [filter, pageIndex, sortBy]);\n  useEffect(() => {\n    const onEnterModal = async () => {\n      _setTimeout(() => {var _searchRef$current;return searchRef == null ? void 0 : (_searchRef$current = searchRef.current) == null ? void 0 : _searchRef$current.focus();}, 200);\n    };\n    if (show) {\n      onEnterModal();\n    }\n  }, [\n  addDangerToast,\n  fetchData,\n  onChange,\n  onDatasourceSave,\n  onHide,\n  selectDatasource,\n  show]);\n\n  const changeSearch = event => {var _event$target$value;\n    const searchValue = (_event$target$value = event.target.value) != null ? _event$target$value : '';\n    setFilter(searchValue);\n    setPageIndex(0);\n  };\n  const handleChangeConfirm = () => {\n    SupersetClient.get({\n      endpoint: `/datasource/get/${confirmedDataset == null ? void 0 : confirmedDataset.type}/${confirmedDataset == null ? void 0 : confirmedDataset.id}/` }).\n\n    then(({ json }) => {\n      onDatasourceSave(json);\n      onChange(`${confirmedDataset == null ? void 0 : confirmedDataset.id}__table`);\n    }).\n    catch(response => {\n      getClientErrorObject(response).then(({ error, message }) => {\n        const errorMessage = error ?\n        error.error || error.statusText || error :\n        message;\n        addDangerToast(errorMessage);\n      });\n    });\n    onHide();\n    addSuccessToast('Successfully changed dataset!');\n  };\n  const handlerCancelConfirm = () => {\n    setConfirmChange(false);\n  };\n  const columns = [\n  {\n    Cell: ({ row: { original } }) => ___EmotionJSX(StyledSpan, { role: \"button\", tabIndex: 0, \"data-test\": \"datasource-link\", onClick: () => selectDatasource({ type: 'table', ...original }) },\n    original == null ? void 0 : original.table_name),\n\n    Header: t('Name'),\n    accessor: 'table_name' },\n\n  {\n    Header: t('Type'),\n    accessor: 'kind',\n    disableSortBy: true },\n\n  {\n    Header: t('Schema'),\n    accessor: 'schema' },\n\n  {\n    Header: t('Connection'),\n    accessor: 'database.database_name',\n    disableSortBy: true },\n\n  {\n    Cell: ({ row: { original: { owners = [] } } }) => ___EmotionJSX(FacePile, { users: owners }),\n    Header: t('Owners'),\n    id: 'owners',\n    disableSortBy: true }];\n\n\n  const onServerPagination = args => {\n    setPageIndex(args.pageIndex);\n    if (args.sortBy) {\n      // ensure default sort by\n      setSortBy(args.sortBy.length > 0 ? args.sortBy : DATASET_SORT_BY);\n    }\n  };\n  return ___EmotionJSX(StyledModal, { show: show, onHide: onHide, responsive: true, title: t('Change dataset'), width: confirmChange ? '432px' : '', height: confirmChange ? 'auto' : '540px', hideFooter: !confirmChange, footer: ___EmotionJSX(React.Fragment, null,\n    confirmChange && ___EmotionJSX(ConfirmModalStyled, null,\n    ___EmotionJSX(\"div\", { className: \"btn-container\" },\n    ___EmotionJSX(Button, { onClick: handlerCancelConfirm }, \"Cancel\"),\n    ___EmotionJSX(Button, { className: \"proceed-btn\", buttonStyle: \"primary\", onClick: handleChangeConfirm }, \"Proceed\")))) },\n\n\n\n\n\n  ___EmotionJSX(React.Fragment, null,\n  !confirmChange && ___EmotionJSX(React.Fragment, null,\n  ___EmotionJSX(Alert, { roomBelow: true, type: \"warning\", css: theme => ({ marginBottom: theme.gridUnit * 4 }), message: ___EmotionJSX(React.Fragment, null,\n    ___EmotionJSX(\"strong\", null, t('Warning!')), \" \", CHANGE_WARNING_MSG) }),\n\n  ___EmotionJSX(Input, { ref: searchRef, type: \"text\", value: filter, placeholder: t('Search / Filter'), onChange: changeSearch }),\n  loading && ___EmotionJSX(Loading, null),\n  !loading && ___EmotionJSX(TableView, { columns: columns, data: resourceCollection, pageSize: DATASET_PAGE_SIZE, initialPageIndex: pageIndex, initialSortBy: sortBy, totalCount: resourceCount, onServerPagination: onServerPagination, className: \"table-condensed\", emptyWrapperType: EmptyWrapperType.Small, serverPagination: true, isPaginationSticky: true, scrollTable: true })),\n\n  confirmChange && ___EmotionJSX(React.Fragment, null, CONFIRM_WARNING_MESSAGE)));\n\n\n};__signature__(ChangeDatasourceModal, \"useState{[filter, setFilter](undefined)}\\nuseState{[pageIndex, setPageIndex](0)}\\nuseState{[sortBy, setSortBy](DATASET_SORT_BY)}\\nuseState{[confirmChange, setConfirmChange](false)}\\nuseState{[confirmedDataset, setConfirmedDataset]}\\nuseRef{searchRef}\\nuseListViewResource{{ state: { loading, resourceCollection, resourceCount }, fetchData, }}\\nuseCallback{selectDatasource}\\nuseDebouncedEffect{}\\nuseEffect{}\", () => [useListViewResource, useDebouncedEffect]);const _default =\nwithToasts(ChangeDatasourceModal);export default _default;;(function () {var reactHotLoader = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.default : undefined;if (!reactHotLoader) {return;}reactHotLoader.register(CONFIRM_WARNING_MESSAGE, \"CONFIRM_WARNING_MESSAGE\", \"/app/superset-frontend/src/datasource/ChangeDatasourceModal.tsx\");reactHotLoader.register(CHANGE_WARNING_MSG, \"CHANGE_WARNING_MSG\", \"/app/superset-frontend/src/datasource/ChangeDatasourceModal.tsx\");reactHotLoader.register(ConfirmModalStyled, \"ConfirmModalStyled\", \"/app/superset-frontend/src/datasource/ChangeDatasourceModal.tsx\");reactHotLoader.register(StyledSpan, \"StyledSpan\", \"/app/superset-frontend/src/datasource/ChangeDatasourceModal.tsx\");reactHotLoader.register(ChangeDatasourceModal, \"ChangeDatasourceModal\", \"/app/superset-frontend/src/datasource/ChangeDatasourceModal.tsx\");reactHotLoader.register(_default, \"default\", \"/app/superset-frontend/src/datasource/ChangeDatasourceModal.tsx\");})();;(function () {var leaveModule = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.leaveModule : undefined;leaveModule && leaveModule(module);})();","map":{"version":3,"sources":["/app/superset-frontend/src/datasource/ChangeDatasourceModal.tsx"],"names":[],"mappings":"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","sourcesContent":["/**\n * Licensed to the Apache Software Foundation (ASF) under one\n * or more contributor license agreements.  See the NOTICE file\n * distributed with this work for additional information\n * regarding copyright ownership.  The ASF licenses this file\n * to you under the Apache License, Version 2.0 (the\n * \"License\"); you may not use this file except in compliance\n * with the License.  You may obtain a copy of the License at\n *\n *   http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing,\n * software distributed under the License is distributed on an\n * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n * KIND, either express or implied.  See the License for the\n * specific language governing permissions and limitations\n * under the License.\n */\nimport React, {\n  FunctionComponent,\n  useState,\n  useRef,\n  useEffect,\n  useCallback,\n} from 'react';\nimport Alert from 'src/components/Alert';\nimport { SupersetClient, t, styled } from '@superset-ui/core';\nimport TableView, { EmptyWrapperType } from 'src/components/TableView';\nimport { ServerPagination, SortByType } from 'src/components/TableView/types';\nimport StyledModal from 'src/components/Modal';\nimport Button from 'src/components/Button';\nimport { useListViewResource } from 'src/views/CRUD/hooks';\nimport Dataset from 'src/types/Dataset';\nimport { useDebouncedEffect } from 'src/explore/exploreUtils';\nimport { SLOW_DEBOUNCE } from 'src/constants';\nimport { getClientErrorObject } from 'src/utils/getClientErrorObject';\nimport Loading from 'src/components/Loading';\nimport withToasts from 'src/messageToasts/enhancers/withToasts';\nimport { Input, AntdInput } from 'src/common/components';\nimport {\n  PAGE_SIZE as DATASET_PAGE_SIZE,\n  SORT_BY as DATASET_SORT_BY,\n} from 'src/views/CRUD/data/dataset/constants';\nimport FacePile from '../components/FacePile';\n\nconst CONFIRM_WARNING_MESSAGE = t(\n  'Warning! Changing the dataset may break the chart if the metadata does not exist.',\n);\n\nconst CHANGE_WARNING_MSG = t(\n  'Changing the dataset may break the chart if the chart relies ' +\n    'on columns or metadata that does not exist in the target dataset',\n);\n\ninterface Datasource {\n  type: string;\n  id: number;\n  uid: string;\n}\n\ninterface ChangeDatasourceModalProps {\n  addDangerToast: (msg: string) => void;\n  addSuccessToast: (msg: string) => void;\n  onChange: (uid: string) => void;\n  onDatasourceSave: (datasource: object, errors?: Array<any>) => {};\n  onHide: () => void;\n  show: boolean;\n}\n\nconst ConfirmModalStyled = styled.div`\n  .btn-container {\n    display: flex;\n    justify-content: flex-end;\n    padding: 0px 15px;\n    margin: 10px 0 0 0;\n  }\n\n  .confirm-modal-container {\n    margin: 9px;\n  }\n`;\n\nconst StyledSpan = styled.span`\n  cursor: pointer;\n  color: ${({ theme }) => theme.colors.primary.dark1};\n  &: hover {\n    color: ${({ theme }) => theme.colors.primary.dark2};\n  }\n`;\n\nconst ChangeDatasourceModal: FunctionComponent<ChangeDatasourceModalProps> = ({\n  addDangerToast,\n  addSuccessToast,\n  onChange,\n  onDatasourceSave,\n  onHide,\n  show,\n}) => {\n  const [filter, setFilter] = useState<any>(undefined);\n  const [pageIndex, setPageIndex] = useState<number>(0);\n  const [sortBy, setSortBy] = useState<SortByType>(DATASET_SORT_BY);\n  const [confirmChange, setConfirmChange] = useState(false);\n  const [confirmedDataset, setConfirmedDataset] = useState<Datasource>();\n  const searchRef = useRef<AntdInput>(null);\n\n  const {\n    state: { loading, resourceCollection, resourceCount },\n    fetchData,\n  } = useListViewResource<Dataset>('dataset', t('dataset'), addDangerToast);\n\n  const selectDatasource = useCallback((datasource: Datasource) => {\n    setConfirmChange(true);\n    setConfirmedDataset(datasource);\n  }, []);\n\n  const fetchDatasetPayload = {\n    pageIndex,\n    pageSize: DATASET_PAGE_SIZE,\n    filters: [],\n    sortBy,\n  };\n\n  useDebouncedEffect(\n    () => {\n      fetchData({\n        ...fetchDatasetPayload,\n        ...(filter && {\n          filters: [\n            {\n              id: 'table_name',\n              operator: 'ct',\n              value: filter,\n            },\n          ],\n        }),\n      });\n    },\n    SLOW_DEBOUNCE,\n    [filter, pageIndex, sortBy],\n  );\n\n  useEffect(() => {\n    const onEnterModal = async () => {\n      setTimeout(() => searchRef?.current?.focus(), 200);\n    };\n\n    if (show) {\n      onEnterModal();\n    }\n  }, [\n    addDangerToast,\n    fetchData,\n    onChange,\n    onDatasourceSave,\n    onHide,\n    selectDatasource,\n    show,\n  ]);\n\n  const changeSearch = (event: React.ChangeEvent<HTMLInputElement>) => {\n    const searchValue = event.target.value ?? '';\n    setFilter(searchValue);\n    setPageIndex(0);\n  };\n\n  const handleChangeConfirm = () => {\n    SupersetClient.get({\n      endpoint: `/datasource/get/${confirmedDataset?.type}/${confirmedDataset?.id}/`,\n    })\n      .then(({ json }) => {\n        onDatasourceSave(json);\n        onChange(`${confirmedDataset?.id}__table`);\n      })\n      .catch(response => {\n        getClientErrorObject(response).then(\n          ({ error, message }: { error: any; message: string }) => {\n            const errorMessage = error\n              ? error.error || error.statusText || error\n              : message;\n            addDangerToast(errorMessage);\n          },\n        );\n      });\n    onHide();\n    addSuccessToast('Successfully changed dataset!');\n  };\n\n  const handlerCancelConfirm = () => {\n    setConfirmChange(false);\n  };\n\n  const columns = [\n    {\n      Cell: ({ row: { original } }: any) => (\n        <StyledSpan\n          role=\"button\"\n          tabIndex={0}\n          data-test=\"datasource-link\"\n          onClick={() => selectDatasource({ type: 'table', ...original })}\n        >\n          {original?.table_name}\n        </StyledSpan>\n      ),\n      Header: t('Name'),\n      accessor: 'table_name',\n    },\n    {\n      Header: t('Type'),\n      accessor: 'kind',\n      disableSortBy: true,\n    },\n    {\n      Header: t('Schema'),\n      accessor: 'schema',\n    },\n    {\n      Header: t('Connection'),\n      accessor: 'database.database_name',\n      disableSortBy: true,\n    },\n    {\n      Cell: ({\n        row: {\n          original: { owners = [] },\n        },\n      }: any) => <FacePile users={owners} />,\n      Header: t('Owners'),\n      id: 'owners',\n      disableSortBy: true,\n    },\n  ];\n\n  const onServerPagination = (args: ServerPagination) => {\n    setPageIndex(args.pageIndex);\n    if (args.sortBy) {\n      // ensure default sort by\n      setSortBy(args.sortBy.length > 0 ? args.sortBy : DATASET_SORT_BY);\n    }\n  };\n\n  return (\n    <StyledModal\n      show={show}\n      onHide={onHide}\n      responsive\n      title={t('Change dataset')}\n      width={confirmChange ? '432px' : ''}\n      height={confirmChange ? 'auto' : '540px'}\n      hideFooter={!confirmChange}\n      footer={\n        <>\n          {confirmChange && (\n            <ConfirmModalStyled>\n              <div className=\"btn-container\">\n                <Button onClick={handlerCancelConfirm}>Cancel</Button>\n                <Button\n                  className=\"proceed-btn\"\n                  buttonStyle=\"primary\"\n                  onClick={handleChangeConfirm}\n                >\n                  Proceed\n                </Button>\n              </div>\n            </ConfirmModalStyled>\n          )}\n        </>\n      }\n    >\n      <>\n        {!confirmChange && (\n          <>\n            <Alert\n              roomBelow\n              type=\"warning\"\n              css={theme => ({ marginBottom: theme.gridUnit * 4 })}\n              message={\n                <>\n                  <strong>{t('Warning!')}</strong> {CHANGE_WARNING_MSG}\n                </>\n              }\n            />\n            <Input\n              ref={searchRef}\n              type=\"text\"\n              value={filter}\n              placeholder={t('Search / Filter')}\n              onChange={changeSearch}\n            />\n            {loading && <Loading />}\n            {!loading && (\n              <TableView\n                columns={columns}\n                data={resourceCollection}\n                pageSize={DATASET_PAGE_SIZE}\n                initialPageIndex={pageIndex}\n                initialSortBy={sortBy}\n                totalCount={resourceCount}\n                onServerPagination={onServerPagination}\n                className=\"table-condensed\"\n                emptyWrapperType={EmptyWrapperType.Small}\n                serverPagination\n                isPaginationSticky\n                scrollTable\n              />\n            )}\n          </>\n        )}\n        {confirmChange && <>{CONFIRM_WARNING_MESSAGE}</>}\n      </>\n    </StyledModal>\n  );\n};\n\nexport default withToasts(ChangeDatasourceModal);\n"],"sourceRoot":""},"metadata":{},"sourceType":"module"}