{"version":3,"sources":["../../../../src/shaderlib/project/viewport-uniforms.js"],"names":["mat4","vec4","COORDINATE_SYSTEM","memoize","assert","PROJECT_COORDINATE_SYSTEM","ZERO_VECTOR","VECTOR_TO_POINT_MATRIX","IDENTITY_MATRIX","DEFAULT_PIXELS_PER_UNIT2","DEFAULT_COORDINATE_ORIGIN","LNGLAT_AUTO_OFFSET_ZOOM_THRESHOLD","getMemoizedViewportUniforms","calculateViewportUniforms","getShaderCoordinateSystem","coordinateSystem","LNGLAT","LNGLAT_EXPERIMENTAL","LNGLAT_AUTO_OFFSET","LNGLAT_DEPRECATED","LNG_LAT","METER_OFFSETS","METERS","LNGLAT_OFFSETS","IDENTITY","calculateMatrixAndOffset","viewport","coordinateOrigin","coordinateZoom","viewMatrixUncentered","viewMatrix","projectionMatrix","viewProjectionMatrix","projectionCenter","cameraPosCommon","cameraPosition","shaderCoordinateSystem","shaderCoordinateOrigin","lng","Math","fround","longitude","lat","latitude","position","positionCommonSpace","projectPosition","pow","transformMat4","multiply","Error","getUniformsFromViewport","devicePixelRatio","modelMatrix","wrapLongitude","projectionMode","positionOrigin","Object","assign","project_uModelMatrix","zoom","distanceScales","getDistanceScales","viewportSize","width","height","uniforms","project_uCoordinateSystem","project_uCenter","project_uWrapLongitude","project_uAntimeridian","project_uViewportSize","project_uDevicePixelRatio","project_uFocalDistance","focalDistance","project_uCommonUnitsPerMeter","pixelsPerMeter","project_uCommonUnitsPerWorldUnit","project_uCommonUnitsPerWorldUnit2","project_uScale","scale","project_uViewProjectionMatrix","project_uCameraPosition","distanceScalesAtOrigin","pixelsPerMeter2","project_uCoordinateOrigin","pixelsPerDegree","pixelsPerDegree2"],"mappings":"AAoBA,OAAO,KAAKA,IAAZ,MAAsB,gBAAtB;AACA,OAAO,KAAKC,IAAZ,MAAsB,gBAAtB;AAEA,SAAQC,iBAAR,QAAgC,qBAAhC;AAEA,OAAOC,OAAP,MAAoB,qBAApB;AACA,OAAOC,MAAP,MAAmB,oBAAnB;AAEA,SAAQC,yBAAR,QAAwC,aAAxC;AAGA,IAAMC,WAAW,GAAG,CAAC,CAAD,EAAI,CAAJ,EAAO,CAAP,EAAU,CAAV,CAApB;AAEA,IAAMC,sBAAsB,GAAG,CAAC,CAAD,EAAI,CAAJ,EAAO,CAAP,EAAU,CAAV,EAAa,CAAb,EAAgB,CAAhB,EAAmB,CAAnB,EAAsB,CAAtB,EAAyB,CAAzB,EAA4B,CAA5B,EAA+B,CAA/B,EAAkC,CAAlC,EAAqC,CAArC,EAAwC,CAAxC,EAA2C,CAA3C,EAA8C,CAA9C,CAA/B;AACA,IAAMC,eAAe,GAAG,CAAC,CAAD,EAAI,CAAJ,EAAO,CAAP,EAAU,CAAV,EAAa,CAAb,EAAgB,CAAhB,EAAmB,CAAnB,EAAsB,CAAtB,EAAyB,CAAzB,EAA4B,CAA5B,EAA+B,CAA/B,EAAkC,CAAlC,EAAqC,CAArC,EAAwC,CAAxC,EAA2C,CAA3C,EAA8C,CAA9C,CAAxB;AACA,IAAMC,wBAAwB,GAAG,CAAC,CAAD,EAAI,CAAJ,EAAO,CAAP,CAAjC;AACA,IAAMC,yBAAyB,GAAG,CAAC,CAAD,EAAI,CAAJ,EAAO,CAAP,CAAlC;AAGA,OAAO,IAAMC,iCAAiC,GAAG,EAA1C;AAEP,IAAMC,2BAA2B,GAAGT,OAAO,CAACU,yBAAD,CAA3C;;AAEA,SAASC,yBAAT,CAAmCC,gBAAnC,EAAqD;AACnD,UAAQA,gBAAR;AACE,SAAKb,iBAAiB,CAACc,MAAvB;AACA,SAAKd,iBAAiB,CAACe,mBAAvB;AACA;AACE,aAAOZ,yBAAyB,CAACa,kBAAjC;;AAEF,SAAKhB,iBAAiB,CAACiB,iBAAvB;AACE,aAAOd,yBAAyB,CAACe,OAAjC;;AAEF,SAAKlB,iBAAiB,CAACmB,aAAvB;AACA,SAAKnB,iBAAiB,CAACoB,MAAvB;AACE,aAAOjB,yBAAyB,CAACgB,aAAjC;;AAEF,SAAKnB,iBAAiB,CAACqB,cAAvB;AACE,aAAOlB,yBAAyB,CAACkB,cAAjC;;AAEF,SAAKrB,iBAAiB,CAACsB,QAAvB;AACE,aAAOnB,yBAAyB,CAACmB,QAAjC;AAjBJ;AAmBD;;AAKD,SAASC,wBAAT,OAOG;AAAA,MALDC,QAKC,QALDA,QAKC;AAAA,MAHDX,gBAGC,QAHDA,gBAGC;AAAA,MAFDY,gBAEC,QAFDA,gBAEC;AAAA,MADDC,cACC,QADDA,cACC;AAAA,MACMC,oBADN,GAC8BH,QAD9B,CACMG,oBADN;AAAA,MAEIC,UAFJ,GAEkBJ,QAFlB,CAEII,UAFJ;AAAA,MAGMC,gBAHN,GAG0BL,QAH1B,CAGMK,gBAHN;AAAA,MAIIC,oBAJJ,GAI4BN,QAJ5B,CAIIM,oBAJJ;AAMD,MAAIC,gBAAJ;AACA,MAAIC,eAAe,GAAGR,QAAQ,CAACS,cAA/B;AACA,MAAIC,sBAAsB,GAAGtB,yBAAyB,CAACC,gBAAD,CAAtD;AACA,MAAIsB,sBAAsB,GAAGV,gBAA7B;;AAEA,MAAIS,sBAAsB,KAAK/B,yBAAyB,CAACa,kBAAzD,EAA6E;AAC3E,QAAIU,cAAc,GAAGjB,iCAArB,EAAwD;AAEtDyB,MAAAA,sBAAsB,GAAG/B,yBAAyB,CAACe,OAAnD;AACD,KAHD,MAGO;AAEL,UAAMkB,GAAG,GAAGC,IAAI,CAACC,MAAL,CAAYd,QAAQ,CAACe,SAArB,CAAZ;AACA,UAAMC,GAAG,GAAGH,IAAI,CAACC,MAAL,CAAYd,QAAQ,CAACiB,QAArB,CAAZ;AACAN,MAAAA,sBAAsB,GAAG,CAACC,GAAD,EAAMI,GAAN,CAAzB;AACD;AACF;;AACD,MAAIN,sBAAsB,KAAK/B,yBAAyB,CAACmB,QAAzD,EAAmE;AAEjEa,IAAAA,sBAAsB,GAAG,CAACE,IAAI,CAACC,MAAL,CAAYd,QAAQ,CAACkB,QAAT,CAAkB,CAAlB,CAAZ,CAAD,EAAoCL,IAAI,CAACC,MAAL,CAAYd,QAAQ,CAACkB,QAAT,CAAkB,CAAlB,CAAZ,CAApC,CAAzB;AACD;;AAEDP,EAAAA,sBAAsB,CAAC,CAAD,CAAtB,GAA4BA,sBAAsB,CAAC,CAAD,CAAtB,IAA6B,CAAzD;;AAEA,UAAQD,sBAAR;AACE,SAAK/B,yBAAyB,CAACe,OAA/B;AACEa,MAAAA,gBAAgB,GAAG3B,WAAnB;AACA;;AAGF,SAAKD,yBAAyB,CAACkB,cAA/B;AACA,SAAKlB,yBAAyB,CAACgB,aAA/B;AACA,SAAKhB,yBAAyB,CAACa,kBAA/B;AACA,SAAKb,yBAAyB,CAACmB,QAA/B;AAIE,UAAMqB,mBAAmB,GAAGnB,QAAQ,CAACoB,eAAT,CAC1BT,sBAD0B,EAE1BE,IAAI,CAACQ,GAAL,CAAS,CAAT,EAAYnB,cAAZ,CAF0B,CAA5B;AAKAM,MAAAA,eAAe,GAAG,CAChBA,eAAe,CAAC,CAAD,CAAf,GAAqBW,mBAAmB,CAAC,CAAD,CADxB,EAEhBX,eAAe,CAAC,CAAD,CAAf,GAAqBW,mBAAmB,CAAC,CAAD,CAFxB,EAGhBX,eAAe,CAAC,CAAD,CAAf,GAAqBW,mBAAmB,CAAC,CAAD,CAHxB,CAAlB;AAMAA,MAAAA,mBAAmB,CAAC,CAAD,CAAnB,GAAyB,CAAzB;AAIAZ,MAAAA,gBAAgB,GAAGhC,IAAI,CAAC+C,aAAL,CAAmB,EAAnB,EAAuBH,mBAAvB,EAA4Cb,oBAA5C,CAAnB;AAGAF,MAAAA,UAAU,GAAGD,oBAAoB,IAAIC,UAArC;AAKAE,MAAAA,oBAAoB,GAAGhC,IAAI,CAACiD,QAAL,CAAc,EAAd,EAAkBlB,gBAAlB,EAAoCD,UAApC,CAAvB;AACAE,MAAAA,oBAAoB,GAAGhC,IAAI,CAACiD,QAAL,CAAc,EAAd,EAAkBjB,oBAAlB,EAAwCzB,sBAAxC,CAAvB;AACA;;AAEF;AACE,YAAM,IAAI2C,KAAJ,CAAU,yBAAV,CAAN;AAzCJ;;AA4CA,SAAO;AACLpB,IAAAA,UAAU,EAAVA,UADK;AAELE,IAAAA,oBAAoB,EAApBA,oBAFK;AAGLC,IAAAA,gBAAgB,EAAhBA,gBAHK;AAILC,IAAAA,eAAe,EAAfA,eAJK;AAKLE,IAAAA,sBAAsB,EAAtBA,sBALK;AAMLC,IAAAA,sBAAsB,EAAtBA;AANK,GAAP;AAQD;;AAWD,OAAO,SAASc,uBAAT,GAWC;AAAA,kFAAJ,EAAI;AAAA,MAVNzB,QAUM,SAVNA,QAUM;AAAA,oCATN0B,gBASM;AAAA,MATNA,gBASM,sCATa,CASb;AAAA,gCARNC,WAQM;AAAA,MARNA,WAQM,kCARQ,IAQR;AAAA,oCANNtC,gBAMM;AAAA,MANNA,gBAMM,sCANab,iBAAiB,CAACc,MAM/B;AAAA,oCALNW,gBAKM;AAAA,MALNA,gBAKM,sCALajB,yBAKb;AAAA,kCAJN4C,aAIM;AAAA,MAJNA,aAIM,oCAJU,KAIV;AAAA,MAFNC,cAEM,SAFNA,cAEM;AAAA,MADNC,cACM,SADNA,cACM;;AACNpD,EAAAA,MAAM,CAACsB,QAAD,CAAN;AAEA,SAAO+B,MAAM,CAACC,MAAP,CACL;AACEC,IAAAA,oBAAoB,EAAEN,WAAW,IAAI7C;AADvC,GADK,EAILI,2BAA2B,CAAC;AAC1Bc,IAAAA,QAAQ,EAARA,QAD0B;AAE1B0B,IAAAA,gBAAgB,EAAhBA,gBAF0B;AAG1BrC,IAAAA,gBAAgB,EAAhBA,gBAH0B;AAI1BY,IAAAA,gBAAgB,EAAhBA,gBAJ0B;AAK1B2B,IAAAA,aAAa,EAAbA;AAL0B,GAAD,CAJtB,CAAP;AAYD;;AAED,SAASzC,yBAAT,QAMG;AAAA,MALDa,QAKC,SALDA,QAKC;AAAA,MAJD0B,gBAIC,SAJDA,gBAIC;AAAA,MAHDrC,gBAGC,SAHDA,gBAGC;AAAA,MAFDY,gBAEC,SAFDA,gBAEC;AAAA,MADD2B,aACC,SADDA,aACC;AACD,MAAM1B,cAAc,GAAGF,QAAQ,CAACkC,IAAhC;;AADC,8BASGnC,wBAAwB,CAAC;AAC3BV,IAAAA,gBAAgB,EAAhBA,gBAD2B;AAE3BY,IAAAA,gBAAgB,EAAhBA,gBAF2B;AAG3BC,IAAAA,cAAc,EAAdA,cAH2B;AAI3BF,IAAAA,QAAQ,EAARA;AAJ2B,GAAD,CAT3B;AAAA,MAICO,gBAJD,yBAICA,gBAJD;AAAA,MAKCD,oBALD,yBAKCA,oBALD;AAAA,MAMCE,eAND,yBAMCA,eAND;AAAA,MAOCE,sBAPD,yBAOCA,sBAPD;AAAA,MAQCC,sBARD,yBAQCA,sBARD;;AAgBDjC,EAAAA,MAAM,CAAC4B,oBAAD,EAAuB,4CAAvB,CAAN;AAGA,MAAM6B,cAAc,GAAGnC,QAAQ,CAACoC,iBAAT,EAAvB;AAEA,MAAMC,YAAY,GAAG,CAACrC,QAAQ,CAACsC,KAAT,GAAiBZ,gBAAlB,EAAoC1B,QAAQ,CAACuC,MAAT,GAAkBb,gBAAtD,CAArB;AAEA,MAAMc,QAAQ,GAAG;AAEfC,IAAAA,yBAAyB,EAAE/B,sBAFZ;AAGfgC,IAAAA,eAAe,EAAEnC,gBAHF;AAIfoC,IAAAA,sBAAsB,EAAEf,aAJT;AAKfgB,IAAAA,qBAAqB,EAAE,CAAC5C,QAAQ,CAACe,SAAT,IAAsB,CAAvB,IAA4B,GALpC;AAQf8B,IAAAA,qBAAqB,EAAER,YARR;AASfS,IAAAA,yBAAyB,EAAEpB,gBATZ;AAYfqB,IAAAA,sBAAsB,EAAE/C,QAAQ,CAACgD,aAAT,IAA0B,CAZnC;AAafC,IAAAA,4BAA4B,EAAEd,cAAc,CAACe,cAb9B;AAcfC,IAAAA,gCAAgC,EAAEhB,cAAc,CAACe,cAdlC;AAefE,IAAAA,iCAAiC,EAAErE,wBAfpB;AAgBfsE,IAAAA,cAAc,EAAErD,QAAQ,CAACsD,KAhBV;AAkBfC,IAAAA,6BAA6B,EAAEjD,oBAlBhB;AAqBfkD,IAAAA,uBAAuB,EAAEhD;AArBV,GAAjB;AAwBA,MAAMiD,sBAAsB,GAAGzD,QAAQ,CAACoC,iBAAT,CAA2BzB,sBAA3B,CAA/B;;AACA,UAAQD,sBAAR;AACE,SAAK/B,yBAAyB,CAACgB,aAA/B;AACE6C,MAAAA,QAAQ,CAACW,gCAAT,GAA4CM,sBAAsB,CAACP,cAAnE;AACAV,MAAAA,QAAQ,CAACY,iCAAT,GAA6CK,sBAAsB,CAACC,eAApE;AACA;;AAEF,SAAK/E,yBAAyB,CAACa,kBAA/B;AACEgD,MAAAA,QAAQ,CAACmB,yBAAT,GAAqChD,sBAArC;;AAEF,SAAKhC,yBAAyB,CAACe,OAA/B;AACA,SAAKf,yBAAyB,CAACkB,cAA/B;AACE2C,MAAAA,QAAQ,CAACW,gCAAT,GAA4CM,sBAAsB,CAACG,eAAnE;AACApB,MAAAA,QAAQ,CAACY,iCAAT,GAA6CK,sBAAsB,CAACI,gBAApE;AACA;;AAEF,SAAKlF,yBAAyB,CAACmB,QAA/B;AACE0C,MAAAA,QAAQ,CAACmB,yBAAT,GAAqChD,sBAArC;AACA;;AAEF;AACE;AApBJ;;AAuBA,SAAO6B,QAAP;AACD","sourcesContent":["// Copyright (c) 2015 - 2017 Uber Technologies, Inc.\n//\n// Permission is hereby granted, free of charge, to any person obtaining a copy\n// of this software and associated documentation files (the \"Software\"), to deal\n// in the Software without restriction, including without limitation the rights\n// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n// copies of the Software, and to permit persons to whom the Software is\n// furnished to do so, subject to the following conditions:\n//\n// The above copyright notice and this permission notice shall be included in\n// all copies or substantial portions of the Software.\n//\n// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n// THE SOFTWARE.\n\nimport * as mat4 from 'gl-matrix/mat4';\nimport * as vec4 from 'gl-matrix/vec4';\n\nimport {COORDINATE_SYSTEM} from '../../lib/constants';\n\nimport memoize from '../../utils/memoize';\nimport assert from '../../utils/assert';\n\nimport {PROJECT_COORDINATE_SYSTEM} from './constants';\n\n// To quickly set a vector to zero\nconst ZERO_VECTOR = [0, 0, 0, 0];\n// 4x4 matrix that drops 4th component of vector\nconst VECTOR_TO_POINT_MATRIX = [1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0];\nconst IDENTITY_MATRIX = [1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1];\nconst DEFAULT_PIXELS_PER_UNIT2 = [0, 0, 0];\nconst DEFAULT_COORDINATE_ORIGIN = [0, 0, 0];\n\n// Based on viewport-mercator-project/test/fp32-limits.js\nexport const LNGLAT_AUTO_OFFSET_ZOOM_THRESHOLD = 12;\n\nconst getMemoizedViewportUniforms = memoize(calculateViewportUniforms);\n\nfunction getShaderCoordinateSystem(coordinateSystem) {\n  switch (coordinateSystem) {\n    case COORDINATE_SYSTEM.LNGLAT:\n    case COORDINATE_SYSTEM.LNGLAT_EXPERIMENTAL:\n    default:\n      return PROJECT_COORDINATE_SYSTEM.LNGLAT_AUTO_OFFSET;\n\n    case COORDINATE_SYSTEM.LNGLAT_DEPRECATED:\n      return PROJECT_COORDINATE_SYSTEM.LNG_LAT;\n\n    case COORDINATE_SYSTEM.METER_OFFSETS:\n    case COORDINATE_SYSTEM.METERS:\n      return PROJECT_COORDINATE_SYSTEM.METER_OFFSETS;\n\n    case COORDINATE_SYSTEM.LNGLAT_OFFSETS:\n      return PROJECT_COORDINATE_SYSTEM.LNGLAT_OFFSETS;\n\n    case COORDINATE_SYSTEM.IDENTITY:\n      return PROJECT_COORDINATE_SYSTEM.IDENTITY;\n  }\n}\n\n// The code that utilizes Matrix4 does the same calculation as their mat4 counterparts,\n// has lower performance but provides error checking.\n// Uncomment when debugging\nfunction calculateMatrixAndOffset({\n  // UNCHANGED\n  viewport,\n  // NEW PARAMS\n  coordinateSystem,\n  coordinateOrigin,\n  coordinateZoom\n}) {\n  const {viewMatrixUncentered} = viewport;\n  let {viewMatrix} = viewport;\n  const {projectionMatrix} = viewport;\n  let {viewProjectionMatrix} = viewport;\n\n  let projectionCenter;\n  let cameraPosCommon = viewport.cameraPosition;\n  let shaderCoordinateSystem = getShaderCoordinateSystem(coordinateSystem);\n  let shaderCoordinateOrigin = coordinateOrigin;\n\n  if (shaderCoordinateSystem === PROJECT_COORDINATE_SYSTEM.LNGLAT_AUTO_OFFSET) {\n    if (coordinateZoom < LNGLAT_AUTO_OFFSET_ZOOM_THRESHOLD) {\n      // Use LNG_LAT projection if not zooming\n      shaderCoordinateSystem = PROJECT_COORDINATE_SYSTEM.LNG_LAT;\n    } else {\n      // Use LNGLAT_AUTO_OFFSET\n      const lng = Math.fround(viewport.longitude);\n      const lat = Math.fround(viewport.latitude);\n      shaderCoordinateOrigin = [lng, lat];\n    }\n  }\n  if (shaderCoordinateSystem === PROJECT_COORDINATE_SYSTEM.IDENTITY) {\n    // We only support 64-bit precision in the X and Y components of positions for now\n    shaderCoordinateOrigin = [Math.fround(viewport.position[0]), Math.fround(viewport.position[1])];\n  }\n\n  shaderCoordinateOrigin[2] = shaderCoordinateOrigin[2] || 0;\n\n  switch (shaderCoordinateSystem) {\n    case PROJECT_COORDINATE_SYSTEM.LNG_LAT:\n      projectionCenter = ZERO_VECTOR;\n      break;\n\n    // TODO: make lighting work for meter offset mode\n    case PROJECT_COORDINATE_SYSTEM.LNGLAT_OFFSETS:\n    case PROJECT_COORDINATE_SYSTEM.METER_OFFSETS:\n    case PROJECT_COORDINATE_SYSTEM.LNGLAT_AUTO_OFFSET:\n    case PROJECT_COORDINATE_SYSTEM.IDENTITY:\n      // Calculate transformed projectionCenter (using 64 bit precision JS)\n      // This is the key to offset mode precision\n      // (avoids doing this addition in 32 bit precision in GLSL)\n      const positionCommonSpace = viewport.projectPosition(\n        shaderCoordinateOrigin,\n        Math.pow(2, coordinateZoom)\n      );\n\n      cameraPosCommon = [\n        cameraPosCommon[0] - positionCommonSpace[0],\n        cameraPosCommon[1] - positionCommonSpace[1],\n        cameraPosCommon[2] - positionCommonSpace[2]\n      ];\n\n      positionCommonSpace[3] = 1;\n\n      // projectionCenter = new Matrix4(viewProjectionMatrix)\n      //   .transformVector([positionPixels[0], positionPixels[1], 0.0, 1.0]);\n      projectionCenter = vec4.transformMat4([], positionCommonSpace, viewProjectionMatrix);\n\n      // Always apply uncentered projection matrix if available (shader adds center)\n      viewMatrix = viewMatrixUncentered || viewMatrix;\n\n      // Zero out 4th coordinate (\"after\" model matrix) - avoids further translations\n      // viewMatrix = new Matrix4(viewMatrixUncentered || viewMatrix)\n      //   .multiplyRight(VECTOR_TO_POINT_MATRIX);\n      viewProjectionMatrix = mat4.multiply([], projectionMatrix, viewMatrix);\n      viewProjectionMatrix = mat4.multiply([], viewProjectionMatrix, VECTOR_TO_POINT_MATRIX);\n      break;\n\n    default:\n      throw new Error('Unknown projection mode');\n  }\n\n  return {\n    viewMatrix,\n    viewProjectionMatrix,\n    projectionCenter,\n    cameraPosCommon,\n    shaderCoordinateSystem,\n    shaderCoordinateOrigin\n  };\n}\n\n/**\n * Returns uniforms for shaders based on current projection\n * includes: projection matrix suitable for shaders\n *\n * TODO - Ensure this works with any viewport, not just WebMercatorViewports\n *\n * @param {WebMercatorViewport} viewport -\n * @return {Float32Array} - 4x4 projection matrix that can be used in shaders\n */\nexport function getUniformsFromViewport({\n  viewport,\n  devicePixelRatio = 1,\n  modelMatrix = null,\n  // Match Layer.defaultProps\n  coordinateSystem = COORDINATE_SYSTEM.LNGLAT,\n  coordinateOrigin = DEFAULT_COORDINATE_ORIGIN,\n  wrapLongitude = false,\n  // Deprecated\n  projectionMode,\n  positionOrigin\n} = {}) {\n  assert(viewport);\n\n  return Object.assign(\n    {\n      project_uModelMatrix: modelMatrix || IDENTITY_MATRIX\n    },\n    getMemoizedViewportUniforms({\n      viewport,\n      devicePixelRatio,\n      coordinateSystem,\n      coordinateOrigin,\n      wrapLongitude\n    })\n  );\n}\n\nfunction calculateViewportUniforms({\n  viewport,\n  devicePixelRatio,\n  coordinateSystem,\n  coordinateOrigin,\n  wrapLongitude\n}) {\n  const coordinateZoom = viewport.zoom;\n\n  const {\n    projectionCenter,\n    viewProjectionMatrix,\n    cameraPosCommon,\n    shaderCoordinateSystem,\n    shaderCoordinateOrigin\n  } = calculateMatrixAndOffset({\n    coordinateSystem,\n    coordinateOrigin,\n    coordinateZoom,\n    viewport\n  });\n\n  assert(viewProjectionMatrix, 'Viewport missing modelViewProjectionMatrix');\n\n  // Calculate projection pixels per unit\n  const distanceScales = viewport.getDistanceScales();\n\n  const viewportSize = [viewport.width * devicePixelRatio, viewport.height * devicePixelRatio];\n\n  const uniforms = {\n    // Projection mode values\n    project_uCoordinateSystem: shaderCoordinateSystem,\n    project_uCenter: projectionCenter,\n    project_uWrapLongitude: wrapLongitude,\n    project_uAntimeridian: (viewport.longitude || 0) - 180,\n\n    // Screen size\n    project_uViewportSize: viewportSize,\n    project_uDevicePixelRatio: devicePixelRatio,\n\n    // Distance at which screen pixels are projected\n    project_uFocalDistance: viewport.focalDistance || 1,\n    project_uCommonUnitsPerMeter: distanceScales.pixelsPerMeter,\n    project_uCommonUnitsPerWorldUnit: distanceScales.pixelsPerMeter,\n    project_uCommonUnitsPerWorldUnit2: DEFAULT_PIXELS_PER_UNIT2,\n    project_uScale: viewport.scale, // This is the mercator scale (2 ** zoom)\n\n    project_uViewProjectionMatrix: viewProjectionMatrix,\n\n    // This is for lighting calculations\n    project_uCameraPosition: cameraPosCommon\n  };\n\n  const distanceScalesAtOrigin = viewport.getDistanceScales(shaderCoordinateOrigin);\n  switch (shaderCoordinateSystem) {\n    case PROJECT_COORDINATE_SYSTEM.METER_OFFSETS:\n      uniforms.project_uCommonUnitsPerWorldUnit = distanceScalesAtOrigin.pixelsPerMeter;\n      uniforms.project_uCommonUnitsPerWorldUnit2 = distanceScalesAtOrigin.pixelsPerMeter2;\n      break;\n\n    case PROJECT_COORDINATE_SYSTEM.LNGLAT_AUTO_OFFSET:\n      uniforms.project_uCoordinateOrigin = shaderCoordinateOrigin;\n    // eslint-disable-line no-fallthrough\n    case PROJECT_COORDINATE_SYSTEM.LNG_LAT:\n    case PROJECT_COORDINATE_SYSTEM.LNGLAT_OFFSETS:\n      uniforms.project_uCommonUnitsPerWorldUnit = distanceScalesAtOrigin.pixelsPerDegree;\n      uniforms.project_uCommonUnitsPerWorldUnit2 = distanceScalesAtOrigin.pixelsPerDegree2;\n      break;\n\n    case PROJECT_COORDINATE_SYSTEM.IDENTITY:\n      uniforms.project_uCoordinateOrigin = shaderCoordinateOrigin;\n      break;\n\n    default:\n      break;\n  }\n\n  return uniforms;\n}\n"],"file":"viewport-uniforms.js"}