{"version":3,"sources":["../../../src/lib/seer-integration.js"],"names":["seer","recursiveSet","obj","path","value","length","slice","overrides","Map","setPropOverrides","id","valuePath","isReady","has","set","props","get","applyPropOverrides","overs","forEach","data","layerEditListener","cb","listenFor","seerInitListener","initLayerInSeer","layer","badges","constructor","layerName","listItem","links","state","model","undefined","parent","updateLayerInSeer","throttle","logPayload","multiUpdate","removeLayerInSeer","deleteItem","getAttributeManager","attrs","getAttributes","push","setProps","timerQueryEnabled","lastFrameTime","stats","toFixed"],"mappings":"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","sourcesContent":["import seer from 'seer';\n\n/**\n * Recursively set a nested property of an object given a properties array and a value\n */\nconst recursiveSet = (obj, path, value) => {\n  if (!obj) {\n    return;\n  }\n\n  if (path.length > 1) {\n    recursiveSet(obj[path[0]], path.slice(1), value);\n  } else {\n    obj[path[0]] = value;\n  }\n};\n\nconst overrides = new Map();\n\n/**\n * Create an override on the specify layer, indexed by a valuePath array.\n * Do nothing in case Seer as not been initialized to prevent any preformance drawback.\n */\nexport const setPropOverrides = (id, valuePath, value) => {\n  if (!seer.isReady()) {\n    return;\n  }\n\n  if (!overrides.has(id)) {\n    overrides.set(id, new Map());\n  }\n\n  const props = overrides.get(id);\n  props.set(valuePath, value);\n};\n\n/**\n * Get the props overrides of a specific layer if Seer as been initialized\n * Invalidates the data to be sure new ones are always picked up.\n */\nexport const applyPropOverrides = props => {\n  if (!seer.isReady() || !props.id) {\n    return;\n  }\n\n  const overs = overrides.get(props.id);\n  if (!overs) {\n    return;\n  }\n\n  overs.forEach((value, valuePath) => {\n    recursiveSet(props, valuePath, value);\n    // Invalidate data array if we have a data override\n    if (valuePath[0] === 'data') {\n      props.data = [...props.data];\n    }\n  });\n};\n\n/**\n * Listen for deck.gl edit events\n */\nexport const layerEditListener = cb => {\n  if (!seer.isReady()) {\n    return;\n  }\n\n  seer.listenFor('deck.gl', cb);\n};\n\n/**\n * Listen for seer init events to resend data\n */\nexport const seerInitListener = cb => {\n  if (!seer.isReady()) {\n    return;\n  }\n\n  seer.listenFor('init', cb);\n};\n\nexport const initLayerInSeer = layer => {\n  if (!seer.isReady() || !layer) {\n    return;\n  }\n\n  const badges = [layer.constructor.layerName];\n\n  seer.listItem('deck.gl', layer.id, {\n    badges,\n    // TODO: Seer currently only handles single model layers\n    links: layer.state && layer.state.model ? [`luma.gl:${layer.state.model.id}`] : undefined,\n    parent: layer.parent ? layer.parent.id : undefined\n  });\n};\n\n/**\n * Log layer's properties to Seer\n */\nexport const updateLayerInSeer = layer => {\n  if (!seer.isReady() || seer.throttle(`deck.gl:${layer.id}`, 1e3)) {\n    return;\n  }\n\n  const data = logPayload(layer);\n  seer.multiUpdate('deck.gl', layer.id, data);\n};\n\n/**\n * On finalize of a specify layer, remove it from seer\n */\nexport const removeLayerInSeer = id => {\n  if (!seer.isReady() || !id) {\n    return;\n  }\n\n  seer.deleteItem('deck.gl', id);\n};\n\nfunction logPayload(layer) {\n  const data = [{path: 'objects.props', data: layer.props}];\n\n  const badges = [layer.constructor.layerName];\n\n  if (layer.state) {\n    if (layer.getAttributeManager()) {\n      const attrs = layer.getAttributeManager().getAttributes();\n      data.push({path: 'objects.attributes', data: attrs});\n    }\n    // TODO: Seer currently only handles single model layers\n    if (layer.state.model) {\n      layer.state.model.setProps({timerQueryEnabled: true});\n      const {lastFrameTime} = layer.state.model.stats;\n      if (lastFrameTime) {\n        badges.push(`${(lastFrameTime * 1000).toFixed(0)}Î¼s`);\n      }\n    }\n  }\n\n  data.push({path: 'badges', data: badges});\n\n  return data;\n}\n"],"file":"seer-integration.js"}