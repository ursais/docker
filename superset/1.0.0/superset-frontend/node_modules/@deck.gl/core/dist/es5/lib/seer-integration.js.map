{"version":3,"sources":["../../../src/lib/seer-integration.js"],"names":["recursiveSet","obj","path","value","length","slice","overrides","Map","setPropOverrides","id","valuePath","seer","isReady","has","set","props","get","applyPropOverrides","overs","forEach","data","layerEditListener","cb","listenFor","seerInitListener","initLayerInSeer","layer","badges","constructor","layerName","listItem","links","state","model","undefined","parent","updateLayerInSeer","throttle","logPayload","multiUpdate","removeLayerInSeer","deleteItem","getAttributeManager","attrs","getAttributes","push","setProps","timerQueryEnabled","lastFrameTime","stats","toFixed"],"mappings":"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","sourcesContent":["import seer from 'seer';\n\n/**\n * Recursively set a nested property of an object given a properties array and a value\n */\nconst recursiveSet = (obj, path, value) => {\n  if (!obj) {\n    return;\n  }\n\n  if (path.length > 1) {\n    recursiveSet(obj[path[0]], path.slice(1), value);\n  } else {\n    obj[path[0]] = value;\n  }\n};\n\nconst overrides = new Map();\n\n/**\n * Create an override on the specify layer, indexed by a valuePath array.\n * Do nothing in case Seer as not been initialized to prevent any preformance drawback.\n */\nexport const setPropOverrides = (id, valuePath, value) => {\n  if (!seer.isReady()) {\n    return;\n  }\n\n  if (!overrides.has(id)) {\n    overrides.set(id, new Map());\n  }\n\n  const props = overrides.get(id);\n  props.set(valuePath, value);\n};\n\n/**\n * Get the props overrides of a specific layer if Seer as been initialized\n * Invalidates the data to be sure new ones are always picked up.\n */\nexport const applyPropOverrides = props => {\n  if (!seer.isReady() || !props.id) {\n    return;\n  }\n\n  const overs = overrides.get(props.id);\n  if (!overs) {\n    return;\n  }\n\n  overs.forEach((value, valuePath) => {\n    recursiveSet(props, valuePath, value);\n    // Invalidate data array if we have a data override\n    if (valuePath[0] === 'data') {\n      props.data = [...props.data];\n    }\n  });\n};\n\n/**\n * Listen for deck.gl edit events\n */\nexport const layerEditListener = cb => {\n  if (!seer.isReady()) {\n    return;\n  }\n\n  seer.listenFor('deck.gl', cb);\n};\n\n/**\n * Listen for seer init events to resend data\n */\nexport const seerInitListener = cb => {\n  if (!seer.isReady()) {\n    return;\n  }\n\n  seer.listenFor('init', cb);\n};\n\nexport const initLayerInSeer = layer => {\n  if (!seer.isReady() || !layer) {\n    return;\n  }\n\n  const badges = [layer.constructor.layerName];\n\n  seer.listItem('deck.gl', layer.id, {\n    badges,\n    // TODO: Seer currently only handles single model layers\n    links: layer.state && layer.state.model ? [`luma.gl:${layer.state.model.id}`] : undefined,\n    parent: layer.parent ? layer.parent.id : undefined\n  });\n};\n\n/**\n * Log layer's properties to Seer\n */\nexport const updateLayerInSeer = layer => {\n  if (!seer.isReady() || seer.throttle(`deck.gl:${layer.id}`, 1e3)) {\n    return;\n  }\n\n  const data = logPayload(layer);\n  seer.multiUpdate('deck.gl', layer.id, data);\n};\n\n/**\n * On finalize of a specify layer, remove it from seer\n */\nexport const removeLayerInSeer = id => {\n  if (!seer.isReady() || !id) {\n    return;\n  }\n\n  seer.deleteItem('deck.gl', id);\n};\n\nfunction logPayload(layer) {\n  const data = [{path: 'objects.props', data: layer.props}];\n\n  const badges = [layer.constructor.layerName];\n\n  if (layer.state) {\n    if (layer.getAttributeManager()) {\n      const attrs = layer.getAttributeManager().getAttributes();\n      data.push({path: 'objects.attributes', data: attrs});\n    }\n    // TODO: Seer currently only handles single model layers\n    if (layer.state.model) {\n      layer.state.model.setProps({timerQueryEnabled: true});\n      const {lastFrameTime} = layer.state.model.stats;\n      if (lastFrameTime) {\n        badges.push(`${(lastFrameTime * 1000).toFixed(0)}Î¼s`);\n      }\n    }\n  }\n\n  data.push({path: 'badges', data: badges});\n\n  return data;\n}\n"],"file":"seer-integration.js"}