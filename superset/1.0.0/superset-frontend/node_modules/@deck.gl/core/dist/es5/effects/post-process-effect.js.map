{"version":3,"sources":["../../../src/effects/post-process-effect.js"],"names":["PostProcessEffect","module","props","id","name","gl","passes","createPasses","params","target","switchBuffer","index","length","inputBuffer","outputBuffer","render","pass","delete","Effect","moduleProps","filter","sampler","fs","getFragmentShaderForRenderPass","ScreenPass","map","idn","FILTER_FS_TEMPLATE","func","SAMPLER_FS_TEMPLATE"],"mappings":";;;;;;;;;;;;;;;;;;;AAAA;;AACA;;AAEA;;IAEqBA,iB;;;AACnB,6BAAYC,MAAZ,EAAgC;AAAA;;AAAA,QAAZC,KAAY,uEAAJ,EAAI;AAAA;AAC9B,uHAAMA,KAAN;AACA,UAAKC,EAAL,aAAaF,MAAM,CAACG,IAApB;AACA,4CAAsBH,MAAtB;AACA,UAAKA,MAAL,GAAcA,MAAd;AAJ8B;AAK/B;;;;4BAEOI,E,EAAI;AACV,UAAI,CAAC,KAAKC,MAAV,EAAkB;AAChB,aAAKA,MAAL,GAAcC,YAAY,CAACF,EAAD,EAAK,KAAKJ,MAAV,EAAkB,KAAKE,EAAvB,EAA2B,KAAKD,KAAhC,CAA1B;AACD;AACF;;;2BAEMM,M,EAAQ;AAAA,2BACWA,MADX,CACNC,MADM;AAAA,UACNA,MADM,+BACG,IADH;AAEb,UAAIC,YAAY,GAAG,KAAnB;;AACA,WAAK,IAAIC,KAAK,GAAG,CAAjB,EAAoBA,KAAK,GAAG,KAAKL,MAAL,CAAYM,MAAxC,EAAgDD,KAAK,EAArD,EAAyD;AACvD,YAAME,WAAW,GAAGH,YAAY,GAAGF,MAAM,CAACM,YAAV,GAAyBN,MAAM,CAACK,WAAhE;AACA,YAAIC,YAAY,GAAGJ,YAAY,GAAGF,MAAM,CAACK,WAAV,GAAwBL,MAAM,CAACM,YAA9D;;AACA,YAAIL,MAAM,IAAIE,KAAK,KAAK,KAAKL,MAAL,CAAYM,MAAZ,GAAqB,CAA7C,EAAgD;AAC9CE,UAAAA,YAAY,GAAGL,MAAf;AACD;;AACD,aAAKH,MAAL,CAAYK,KAAZ,EAAmBI,MAAnB,CAA0B;AAACF,UAAAA,WAAW,EAAXA,WAAD;AAAcC,UAAAA,YAAY,EAAZA;AAAd,SAA1B;AACAJ,QAAAA,YAAY,GAAG,CAACA,YAAhB;AACD;;AACD,aAAO;AACLG,QAAAA,WAAW,EAAEH,YAAY,GAAGF,MAAM,CAACM,YAAV,GAAyBN,MAAM,CAACK,WADpD;AAELC,QAAAA,YAAY,EAAEJ,YAAY,GAAGF,MAAM,CAACK,WAAV,GAAwBL,MAAM,CAACM;AAFpD,OAAP;AAID;;;8BAES;AACR,UAAI,KAAKR,MAAT,EAAiB;AAAA;AAAA;AAAA;;AAAA;AACf,+BAAmB,KAAKA,MAAxB,8HAAgC;AAAA,gBAArBU,IAAqB;AAC9BA,YAAAA,IAAI,CAACC,MAAL;AACD;AAHc;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAIf,aAAKX,MAAL,GAAc,IAAd;AACD;AACF;;;EAvC4CY,e;;;;AA0C/C,SAASX,YAAT,CAAsBF,EAAtB,EAA0BJ,MAA1B,EAAkCE,EAAlC,EAAsCgB,WAAtC,EAAmD;AACjD,MAAIlB,MAAM,CAACmB,MAAP,IAAiBnB,MAAM,CAACoB,OAA5B,EAAqC;AACnC,QAAMC,EAAE,GAAGC,8BAA8B,CAACtB,MAAD,CAAzC;AACA,QAAMe,IAAI,GAAG,IAAIQ,mBAAJ,CAAenB,EAAf,EAAmB;AAC9BF,MAAAA,EAAE,EAAFA,EAD8B;AAE9BF,MAAAA,MAAM,EAANA,MAF8B;AAG9BqB,MAAAA,EAAE,EAAFA,EAH8B;AAI9BH,MAAAA,WAAW,EAAXA;AAJ8B,KAAnB,CAAb;AAMA,WAAO,CAACH,IAAD,CAAP;AACD;;AAED,MAAMV,MAAM,GAAGL,MAAM,CAACK,MAAP,IAAiB,EAAhC;AACA,SAAOA,MAAM,CAACmB,GAAP,CAAW,UAACT,IAAD,EAAOL,KAAP,EAAiB;AACjC,QAAMW,EAAE,GAAGC,8BAA8B,CAACtB,MAAD,EAASe,IAAT,CAAzC;AACA,QAAMU,GAAG,aAAMvB,EAAN,cAAYQ,KAAZ,CAAT;AAEA,WAAO,IAAIa,mBAAJ,CAAenB,EAAf,EAAmB;AACxBF,MAAAA,EAAE,EAAEuB,GADoB;AAExBzB,MAAAA,MAAM,EAANA,MAFwB;AAGxBqB,MAAAA,EAAE,EAAFA,EAHwB;AAIxBH,MAAAA,WAAW,EAAXA;AAJwB,KAAnB,CAAP;AAMD,GAVM,CAAP;AAWD;;AAED,IAAMQ,kBAAkB,GAAG,SAArBA,kBAAqB,CAAAC,IAAI;AAAA,+PAYZA,IAZY;AAAA,CAA/B;;AAgBA,IAAMC,mBAAmB,GAAG,SAAtBA,mBAAsB,CAAAD,IAAI;AAAA,+MAWbA,IAXa;AAAA,CAAhC;;AAeA,SAASL,8BAAT,CAAwCtB,MAAxC,EAA+D;AAAA,MAAfe,IAAe,uEAARf,MAAQ;;AAC7D,MAAIe,IAAI,CAACI,MAAT,EAAiB;AACf,QAAMQ,IAAI,GAAG,OAAOZ,IAAI,CAACI,MAAZ,KAAuB,QAAvB,GAAkCJ,IAAI,CAACI,MAAvC,aAAmDnB,MAAM,CAACG,IAA1D,iBAAb;AACA,WAAOuB,kBAAkB,CAACC,IAAD,CAAzB;AACD;;AAED,MAAIZ,IAAI,CAACK,OAAT,EAAkB;AAChB,QAAMO,KAAI,GAAG,OAAOZ,IAAI,CAACK,OAAZ,KAAwB,QAAxB,GAAmCL,IAAI,CAACK,OAAxC,aAAqDpB,MAAM,CAACG,IAA5D,iBAAb;;AACA,WAAOyB,mBAAmB,CAACD,KAAD,CAA1B;AACD;;AAGD,SAAO,IAAP;AACD","sourcesContent":["import Effect from '../lib/effect';\nimport ScreenPass from '../passes/screen-pass';\n/* eslint-disable import/no-extraneous-dependencies */\nimport {normalizeShaderModule} from '@luma.gl/shadertools';\n\nexport default class PostProcessEffect extends Effect {\n  constructor(module, props = {}) {\n    super(props);\n    this.id = `${module.name}-pass`;\n    normalizeShaderModule(module);\n    this.module = module;\n  }\n\n  prepare(gl) {\n    if (!this.passes) {\n      this.passes = createPasses(gl, this.module, this.id, this.props);\n    }\n  }\n\n  render(params) {\n    const {target = null} = params;\n    let switchBuffer = false;\n    for (let index = 0; index < this.passes.length; index++) {\n      const inputBuffer = switchBuffer ? params.outputBuffer : params.inputBuffer;\n      let outputBuffer = switchBuffer ? params.inputBuffer : params.outputBuffer;\n      if (target && index === this.passes.length - 1) {\n        outputBuffer = target;\n      }\n      this.passes[index].render({inputBuffer, outputBuffer});\n      switchBuffer = !switchBuffer;\n    }\n    return {\n      inputBuffer: switchBuffer ? params.outputBuffer : params.inputBuffer,\n      outputBuffer: switchBuffer ? params.inputBuffer : params.outputBuffer\n    };\n  }\n\n  cleanup() {\n    if (this.passes) {\n      for (const pass of this.passes) {\n        pass.delete();\n      }\n      this.passes = null;\n    }\n  }\n}\n\nfunction createPasses(gl, module, id, moduleProps) {\n  if (module.filter || module.sampler) {\n    const fs = getFragmentShaderForRenderPass(module);\n    const pass = new ScreenPass(gl, {\n      id,\n      module,\n      fs,\n      moduleProps\n    });\n    return [pass];\n  }\n\n  const passes = module.passes || [];\n  return passes.map((pass, index) => {\n    const fs = getFragmentShaderForRenderPass(module, pass);\n    const idn = `${id}-${index}`;\n\n    return new ScreenPass(gl, {\n      id: idn,\n      module,\n      fs,\n      moduleProps\n    });\n  });\n}\n\nconst FILTER_FS_TEMPLATE = func => `\\\nuniform sampler2D texture;\nuniform vec2 texSize;\n\nvarying vec2 position;\nvarying vec2 coordinate;\nvarying vec2 uv;\n\nvoid main() {\n  vec2 texCoord = coordinate;\n\n  gl_FragColor = texture2D(texture, texCoord);\n  gl_FragColor = ${func}(gl_FragColor, texSize, texCoord);\n}\n`;\n\nconst SAMPLER_FS_TEMPLATE = func => `\\\nuniform sampler2D texture;\nuniform vec2 texSize;\n\nvarying vec2 position;\nvarying vec2 coordinate;\nvarying vec2 uv;\n\nvoid main() {\n  vec2 texCoord = coordinate;\n\n  gl_FragColor = ${func}(texture, texSize, texCoord);\n}\n`;\n\nfunction getFragmentShaderForRenderPass(module, pass = module) {\n  if (pass.filter) {\n    const func = typeof pass.filter === 'string' ? pass.filter : `${module.name}_filterColor`;\n    return FILTER_FS_TEMPLATE(func);\n  }\n\n  if (pass.sampler) {\n    const func = typeof pass.sampler === 'string' ? pass.sampler : `${module.name}_sampleColor`;\n    return SAMPLER_FS_TEMPLATE(func);\n  }\n\n  // console.error(`${module.name} no fragment shader generated`);\n  return null;\n}\n"],"file":"post-process-effect.js"}