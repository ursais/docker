{"version":3,"sources":["../../../src/path-layer/path-tesselator.js"],"names":["experimental","Tesselator","fp64","fp64Module","fp64LowPart","PathTesselator","constructor","data","getGeometry","positionFormat","attributes","startPositions","size","endPositions","leftPositions","rightPositions","startEndPositions64XyLow","fp64Only","neighborPositions64XyLow","get","attributeName","getGeometrySize","path","Math","max","getPathLength","updateGeometryAttributes","context","numPoints","geometrySize","isPathClosed","isClosed","startPoint","getPointOnPath","endPoint","prevPoint","nextPoint","i","vertexStart","ptIndex","Number","isFinite","length","positionSize","index","firstPoint","lastPoint"],"mappings":"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","sourcesContent":["// Copyright (c) 2015 - 2017 Uber Technologies, Inc.\n//\n// Permission is hereby granted, free of charge, to any person obtaining a copy\n// of this software and associated documentation files (the \"Software\"), to deal\n// in the Software without restriction, including without limitation the rights\n// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n// copies of the Software, and to permit persons to whom the Software is\n// furnished to do so, subject to the following conditions:\n//\n// The above copyright notice and this permission notice shall be included in\n// all copies or substantial portions of the Software.\n//\n// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n// THE SOFTWARE.\nimport {experimental} from '@deck.gl/core';\nconst {Tesselator} = experimental;\nimport {fp64 as fp64Module} from '@luma.gl/core';\nconst {fp64LowPart} = fp64Module;\n\n// This class is set up to allow querying one attribute at a time\n// the way the AttributeManager expects it\nexport default class PathTesselator extends Tesselator {\n  constructor({data, getGeometry, positionFormat, fp64}) {\n    super({\n      data,\n      getGeometry,\n      fp64,\n      positionFormat,\n      attributes: {\n        startPositions: {size: 3},\n        endPositions: {size: 3},\n        leftPositions: {size: 3},\n        rightPositions: {size: 3},\n        startEndPositions64XyLow: {size: 4, fp64Only: true},\n        neighborPositions64XyLow: {size: 4, fp64Only: true}\n      }\n    });\n  }\n\n  /* Getters */\n  get(attributeName) {\n    return this.attributes[attributeName];\n  }\n\n  /* Implement base Tesselator interface */\n  getGeometrySize(path) {\n    return Math.max(0, this.getPathLength(path) - 1);\n  }\n\n  /* eslint-disable max-statements, complexity */\n  updateGeometryAttributes(path, context) {\n    const {\n      attributes: {\n        startPositions,\n        endPositions,\n        leftPositions,\n        rightPositions,\n        startEndPositions64XyLow,\n        neighborPositions64XyLow\n      },\n      fp64\n    } = this;\n\n    const numPoints = context.geometrySize + 1;\n    if (numPoints < 2) {\n      // ignore invalid path\n      return;\n    }\n    const isPathClosed = this.isClosed(path);\n\n    let startPoint = this.getPointOnPath(path, 0);\n    let endPoint = this.getPointOnPath(path, 1);\n    let prevPoint = isPathClosed ? this.getPointOnPath(path, numPoints - 2) : startPoint;\n    let nextPoint;\n\n    for (let i = context.vertexStart, ptIndex = 1; ptIndex < numPoints; i++, ptIndex++) {\n      if (ptIndex + 1 < numPoints) {\n        nextPoint = this.getPointOnPath(path, ptIndex + 1);\n      } else {\n        nextPoint = isPathClosed ? this.getPointOnPath(path, 1) : endPoint;\n      }\n\n      startPositions[i * 3] = startPoint[0];\n      startPositions[i * 3 + 1] = startPoint[1];\n      startPositions[i * 3 + 2] = startPoint[2] || 0;\n\n      endPositions[i * 3] = endPoint[0];\n      endPositions[i * 3 + 1] = endPoint[1];\n      endPositions[i * 3 + 2] = endPoint[2] || 0;\n\n      leftPositions[i * 3] = prevPoint[0];\n      leftPositions[i * 3 + 1] = prevPoint[1];\n      leftPositions[i * 3 + 2] = prevPoint[2] || 0;\n\n      rightPositions[i * 3] = nextPoint[0];\n      rightPositions[i * 3 + 1] = nextPoint[1];\n      rightPositions[i * 3 + 2] = nextPoint[2] || 0;\n\n      if (fp64) {\n        startEndPositions64XyLow[i * 4] = fp64LowPart(startPoint[0]);\n        startEndPositions64XyLow[i * 4 + 1] = fp64LowPart(startPoint[1]);\n        startEndPositions64XyLow[i * 4 + 2] = fp64LowPart(endPoint[0]);\n        startEndPositions64XyLow[i * 4 + 3] = fp64LowPart(endPoint[1]);\n\n        neighborPositions64XyLow[i * 4] = fp64LowPart(prevPoint[0]);\n        neighborPositions64XyLow[i * 4 + 1] = fp64LowPart(prevPoint[1]);\n        neighborPositions64XyLow[i * 4 + 2] = fp64LowPart(nextPoint[0]);\n        neighborPositions64XyLow[i * 4 + 3] = fp64LowPart(nextPoint[1]);\n      }\n\n      prevPoint = startPoint;\n      startPoint = endPoint;\n      endPoint = nextPoint;\n    }\n  }\n  /* eslint-enable max-statements, complexity */\n\n  /* Utilities */\n  getPathLength(path) {\n    if (Number.isFinite(path[0])) {\n      // flat format\n      return path.length / this.positionSize;\n    }\n    return path.length;\n  }\n\n  getPointOnPath(path, index) {\n    if (Number.isFinite(path[0])) {\n      // flat format\n      const {positionSize} = this;\n      // TODO - avoid creating new arrays when using binary\n      return [\n        path[index * positionSize],\n        path[index * positionSize + 1],\n        positionSize === 3 ? path[index * positionSize + 2] : 0\n      ];\n    }\n    return path[index];\n  }\n\n  isClosed(path) {\n    const numPoints = this.getPathLength(path);\n    const firstPoint = this.getPointOnPath(path, 0);\n    const lastPoint = this.getPointOnPath(path, numPoints - 1);\n    return (\n      firstPoint[0] === lastPoint[0] &&\n      firstPoint[1] === lastPoint[1] &&\n      firstPoint[2] === lastPoint[2]\n    );\n  }\n}\n"],"file":"path-tesselator.js"}