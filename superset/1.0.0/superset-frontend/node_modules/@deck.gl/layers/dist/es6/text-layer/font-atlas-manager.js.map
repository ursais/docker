{"version":3,"sources":["../../../src/text-layer/font-atlas-manager.js"],"names":["Texture2D","TinySDF","buildMapping","LRUCache","getDefaultCharacterSet","charSet","i","push","String","fromCharCode","DEFAULT_CHAR_SET","DEFAULT_FONT_FAMILY","DEFAULT_FONT_WEIGHT","DEFAULT_FONT_SIZE","DEFAULT_BUFFER","DEFAULT_CUTOFF","DEFAULT_RADIUS","GL_TEXTURE_WRAP_S","GL_TEXTURE_WRAP_T","GL_CLAMP_TO_EDGE","MAX_CANVAS_WIDTH","BASELINE_SCALE","HEIGHT_SCALE","CACHE_LIMIT","cache","VALID_PROPS","getNewChars","key","characterSet","cachedFontAtlas","get","newChars","cachedMapping","mapping","cachedCharSet","Object","keys","Set","Array","forEach","char","has","populateAlphaChannel","alphaChannel","imageData","length","data","setTextStyle","ctx","fontFamily","fontSize","fontWeight","font","fillStyle","textBaseline","textAlign","FontAtlasManager","constructor","gl","props","buffer","sdf","cutoff","radius","_key","_texture","finalize","delete","texture","scale","setProps","prop","oldKey","_getKey","_updateTexture","fontAtlas","_generateFontAtlas","set","canvas","width","height","resize","setImageData","parameters","generateMipmap","document","createElement","getContext","assign","getFontWidth","measureText","fontHeight","maxCanvasWidth","xOffset","yOffset","canvasHeight","getImageData","putImageData","tinySDF","size","draw","x","y","fillText"],"mappings":"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","sourcesContent":["/* global document */\n\nimport {Texture2D} from '@luma.gl/core';\nimport TinySDF from '@mapbox/tiny-sdf';\nimport GL from '@luma.gl/constants';\n\nimport {buildMapping} from './font-atlas-utils';\nimport LRUCache from './lru-cache';\n\nfunction getDefaultCharacterSet() {\n  const charSet = [];\n  for (let i = 32; i < 128; i++) {\n    charSet.push(String.fromCharCode(i));\n  }\n  return charSet;\n}\n\nexport const DEFAULT_CHAR_SET = getDefaultCharacterSet();\nexport const DEFAULT_FONT_FAMILY = 'Monaco, monospace';\nexport const DEFAULT_FONT_WEIGHT = 'normal';\nexport const DEFAULT_FONT_SIZE = 64;\nexport const DEFAULT_BUFFER = 2;\nexport const DEFAULT_CUTOFF = 0.25;\nexport const DEFAULT_RADIUS = 3;\n\nconst GL_TEXTURE_WRAP_S = 0x2802;\nconst GL_TEXTURE_WRAP_T = 0x2803;\nconst GL_CLAMP_TO_EDGE = 0x812f;\nconst MAX_CANVAS_WIDTH = 1024;\n\nconst BASELINE_SCALE = 0.9;\nconst HEIGHT_SCALE = 1.2;\n\n// only preserve latest three fontAtlas\nconst CACHE_LIMIT = 3;\n\n/**\n * [key]: {\n *   xOffset, // x position of last character in mapping\n *   yOffset, // y position of last character in mapping\n *   mapping, // x, y coordinate of each character in shared `fontAtlas`\n *   data, // canvas\n *   width. // canvas.width,\n *   height, // canvas.height\n * }\n *\n */\nconst cache = new LRUCache(CACHE_LIMIT);\n\nconst VALID_PROPS = [\n  'fontFamily',\n  'fontWeight',\n  'characterSet',\n  'fontSize',\n  'sdf',\n  'buffer',\n  'cutoff',\n  'radius'\n];\n\n/**\n * get all the chars not in cache\n * @param key cache key\n * @param characterSet (Array|Set)\n * @returns {Array} chars not in cache\n */\nfunction getNewChars(key, characterSet) {\n  const cachedFontAtlas = cache.get(key);\n  if (!cachedFontAtlas) {\n    return characterSet;\n  }\n\n  const newChars = [];\n  const cachedMapping = cachedFontAtlas.mapping;\n  let cachedCharSet = Object.keys(cachedMapping);\n  cachedCharSet = new Set(cachedCharSet);\n\n  let charSet = characterSet;\n  if (charSet instanceof Array) {\n    charSet = new Set(charSet);\n  }\n\n  charSet.forEach(char => {\n    if (!cachedCharSet.has(char)) {\n      newChars.push(char);\n    }\n  });\n\n  return newChars;\n}\n\nfunction populateAlphaChannel(alphaChannel, imageData) {\n  // populate distance value from tinySDF to image alpha channel\n  for (let i = 0; i < alphaChannel.length; i++) {\n    imageData.data[4 * i + 3] = alphaChannel[i];\n  }\n}\n\nfunction setTextStyle(ctx, fontFamily, fontSize, fontWeight) {\n  ctx.font = `${fontWeight} ${fontSize}px ${fontFamily}`;\n  ctx.fillStyle = '#000';\n  ctx.textBaseline = 'baseline';\n  ctx.textAlign = 'left';\n}\n\nexport default class FontAtlasManager {\n  constructor(gl) {\n    this.gl = gl;\n\n    // font settings\n    this.props = {\n      fontFamily: DEFAULT_FONT_FAMILY,\n      fontWeight: DEFAULT_FONT_WEIGHT,\n      characterSet: DEFAULT_CHAR_SET,\n      fontSize: DEFAULT_FONT_SIZE,\n      buffer: DEFAULT_BUFFER,\n      // sdf only props\n      // https://github.com/mapbox/tiny-sdf\n      sdf: false,\n      cutoff: DEFAULT_CUTOFF,\n      radius: DEFAULT_RADIUS\n    };\n\n    // key is used for caching generated fontAtlas\n    this._key = null;\n    this._texture = new Texture2D(this.gl);\n  }\n\n  finalize() {\n    this._texture.delete();\n  }\n\n  get texture() {\n    return this._texture;\n  }\n\n  get mapping() {\n    const data = cache.get(this._key);\n    return data && data.mapping;\n  }\n\n  get scale() {\n    return HEIGHT_SCALE;\n  }\n\n  setProps(props = {}) {\n    VALID_PROPS.forEach(prop => {\n      if (prop in props) {\n        this.props[prop] = props[prop];\n      }\n    });\n\n    // update cache key\n    const oldKey = this._key;\n    this._key = this._getKey();\n\n    const charSet = getNewChars(this._key, this.props.characterSet);\n    const cachedFontAtlas = cache.get(this._key);\n\n    // if a fontAtlas associated with the new settings is cached and\n    // there are no new chars\n    if (cachedFontAtlas && charSet.length === 0) {\n      // update texture with cached fontAtlas\n      if (this._key !== oldKey) {\n        this._updateTexture(cachedFontAtlas);\n      }\n      return;\n    }\n\n    // update fontAtlas with new settings\n    const fontAtlas = this._generateFontAtlas(this._key, charSet, cachedFontAtlas);\n    this._updateTexture(fontAtlas);\n\n    // update cache\n    cache.set(this._key, fontAtlas);\n  }\n\n  _updateTexture({data: canvas, width, height}) {\n    // resize texture\n    if (this._texture.width !== width || this._texture.height !== height) {\n      this._texture.resize({width, height});\n    }\n\n    // update image data\n    this._texture.setImageData({\n      data: canvas,\n      width,\n      height,\n      parameters: {\n        [GL_TEXTURE_WRAP_S]: GL_CLAMP_TO_EDGE,\n        [GL_TEXTURE_WRAP_T]: GL_CLAMP_TO_EDGE,\n        [GL.UNPACK_FLIP_Y_WEBGL]: true\n      }\n    });\n\n    // this is required step after texture data changed\n    this._texture.generateMipmap();\n  }\n\n  _generateFontAtlas(key, characterSet, cachedFontAtlas) {\n    const {fontFamily, fontWeight, fontSize, buffer, sdf, radius, cutoff} = this.props;\n    let canvas = cachedFontAtlas && cachedFontAtlas.data;\n    if (!canvas) {\n      canvas = document.createElement('canvas');\n      canvas.width = MAX_CANVAS_WIDTH;\n    }\n    const ctx = canvas.getContext('2d');\n\n    setTextStyle(ctx, fontFamily, fontSize, fontWeight);\n\n    // 1. build mapping\n    const {mapping, canvasHeight, xOffset, yOffset} = buildMapping(\n      Object.assign(\n        {\n          getFontWidth: char => ctx.measureText(char).width,\n          fontHeight: fontSize * HEIGHT_SCALE,\n          buffer,\n          characterSet,\n          maxCanvasWidth: MAX_CANVAS_WIDTH\n        },\n        cachedFontAtlas && {\n          mapping: cachedFontAtlas.mapping,\n          xOffset: cachedFontAtlas.xOffset,\n          yOffset: cachedFontAtlas.yOffset\n        }\n      )\n    );\n\n    // 2. update canvas\n    // copy old canvas data to new canvas only when height changed\n    if (canvas.height !== canvasHeight) {\n      const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);\n      canvas.height = canvasHeight;\n      ctx.putImageData(imageData, 0, 0);\n    }\n    setTextStyle(ctx, fontFamily, fontSize, fontWeight);\n\n    // 3. layout characters\n    if (sdf) {\n      const tinySDF = new TinySDF(fontSize, buffer, radius, cutoff, fontFamily, fontWeight);\n      // used to store distance values from tinySDF\n      // tinySDF.size equals `fontSize + buffer * 2`\n      const imageData = ctx.getImageData(0, 0, tinySDF.size, tinySDF.size);\n\n      for (const char of characterSet) {\n        populateAlphaChannel(tinySDF.draw(char), imageData);\n        ctx.putImageData(imageData, mapping[char].x - buffer, mapping[char].y - buffer);\n      }\n    } else {\n      for (const char of characterSet) {\n        ctx.fillText(char, mapping[char].x, mapping[char].y + fontSize * BASELINE_SCALE);\n      }\n    }\n\n    return {\n      xOffset,\n      yOffset,\n      mapping,\n      data: canvas,\n      width: canvas.width,\n      height: canvas.height\n    };\n  }\n\n  _getKey() {\n    const {gl, fontFamily, fontWeight, fontSize, buffer, sdf, radius, cutoff} = this.props;\n    if (sdf) {\n      return `${gl} ${fontFamily} ${fontWeight} ${fontSize} ${buffer} ${radius} ${cutoff}`;\n    }\n    return `${gl} ${fontFamily} ${fontWeight} ${fontSize} ${buffer}`;\n  }\n}\n"],"file":"font-atlas-manager.js"}