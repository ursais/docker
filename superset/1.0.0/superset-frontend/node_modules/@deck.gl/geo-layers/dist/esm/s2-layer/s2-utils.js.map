{"version":3,"sources":["../../../src/s2-layer/s2-utils.js"],"names":["S2","Long","getIdFromToken","token","paddedToken","padEnd","fromString","RADIAN_TO_DEGREE","Math","PI","MAX_RESOLUTION","XYZToLngLat","x","y","z","lat","atan2","sqrt","lng","getGeoBounds","face","ij","level","result","offsets","resolution","max","pow","i","offset","slice","nextOffset","stepI","stepJ","j","st","IJToST","uv","STToUV","xyz","FaceUVToXYZ","push","getS2QuadKey","indexOf","S2Cell","toHilbertQuadkey","toString","getS2Polygon","key","s2cell","FromHilbertQuadKey"],"mappings":"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","sourcesContent":["// s2-geometry is a pure JavaScript port of Google/Niantic's S2 Geometry library\n// which is perfect since it works in the browser.\nimport {S2} from 's2-geometry';\nimport Long from 'long';\n\n/**\n * Given an S2 token this function convert the token to 64 bit id\n   https://github.com/google/s2-geometry-library-java/blob/c04b68bf3197a9c34082327eeb3aec7ab7c85da1/src/com/google/common/geometry/S2CellId.java#L439\n * */\nfunction getIdFromToken(token) {\n  // pad token with zeros to make the length 16\n  const paddedToken = token.padEnd(16, '0');\n  return Long.fromString(paddedToken, 16);\n}\n\nconst RADIAN_TO_DEGREE = 180 / Math.PI;\nconst MAX_RESOLUTION = 100;\n\n/* Adapted from s2-geometry's S2.XYZToLatLng */\nfunction XYZToLngLat([x, y, z]) {\n  const lat = Math.atan2(z, Math.sqrt(x * x + y * y));\n  const lng = Math.atan2(y, x);\n\n  return [lng * RADIAN_TO_DEGREE, lat * RADIAN_TO_DEGREE];\n}\n\n/* Adapted from s2-geometry's S2Cell.getCornerLatLngs */\nfunction getGeoBounds({face, ij, level}) {\n  const result = [];\n  const offsets = [[0, 0], [0, 1], [1, 1], [1, 0], [0, 0]];\n\n  // The S2 cell edge is curved: http://s2geometry.io/\n  // This is more prominent at lower levels\n  // resolution is the number of segments to generate per edge.\n  // We exponentially reduce resolution as level increases so it doesn't affect perf\n  // when there are a large number of cells\n  const resolution = Math.max(1, MAX_RESOLUTION * Math.pow(2, -level));\n\n  for (let i = 0; i < 4; i++) {\n    const offset = offsets[i].slice(0);\n    const nextOffset = offsets[i + 1];\n    const stepI = (nextOffset[0] - offset[0]) / resolution;\n    const stepJ = (nextOffset[1] - offset[1]) / resolution;\n\n    for (let j = 0; j < resolution; j++) {\n      offset[0] += stepI;\n      offset[1] += stepJ;\n      // Cell can be represented by coordinates IJ, ST, UV, XYZ\n      // http://s2geometry.io/devguide/s2cell_hierarchy#coordinate-systems\n      const st = S2.IJToST(ij, level, offset);\n      const uv = S2.STToUV(st);\n      const xyz = S2.FaceUVToXYZ(face, uv);\n\n      result.push(XYZToLngLat(xyz));\n    }\n  }\n  return result;\n}\n\nexport function getS2QuadKey(token) {\n  if (typeof token === 'string') {\n    if (token.indexOf('/') > 0) {\n      // is Hilbert quad key\n      return token;\n    }\n    // is S2 token\n    token = getIdFromToken(token);\n  }\n  // is Long id\n  return S2.S2Cell.toHilbertQuadkey(token.toString());\n}\n\n/**\n * Get a polygon with corner coordinates for an s2 cell\n * @param {*} cell - This can be an S2 key or token\n * @return {Array} - a simple polygon in array format: [[lng, lat], ...]\n *   - each coordinate is an array [lng, lat]\n *   - the polygon is closed, i.e. last coordinate is a copy of the first coordinate\n */\nexport function getS2Polygon(token) {\n  const key = getS2QuadKey(token);\n  const s2cell = S2.S2Cell.FromHilbertQuadKey(key);\n\n  return getGeoBounds(s2cell);\n}\n"],"file":"s2-utils.js"}