{"version":3,"sources":["../../../src/gpu-grid-layer/gpu-grid-cell-layer.js"],"names":["Layer","Model","CubeGeometry","fp64","PhongMaterial","fp64LowPart","defaultMaterial","defaultColorRange","vs","fs","COLOR_DATA_UBO_INDEX","ELEVATION_DATA_UBO_INDEX","defaultProps","colorDomain","colorRange","elevationDomain","elevationRange","elevationScale","type","min","value","gridSize","gridOrigin","gridOffset","cellSize","max","offset","coverage","extruded","material","GPUGridCellLayer","getShaders","modules","initializeState","gl","context","attributeManager","getAttributeManager","addInstanced","colors","size","update","calculateColors","noAlloc","elevations","calculateElevations","model","_getModel","_setupUniformBuffer","setState","Object","assign","id","props","geometry","isInstanced","shaderCache","draw","uniforms","data","gridOriginLow","gridOffsetLow","colorMaxMinBuffer","color","maxMinBuffer","elevationMaxMinBuffer","elevation","bind","target","index","domainUniforms","getDomainUniforms","state","setUniforms","unbind","attribute","buffer","aggregationBuffer","colorDomainValid","elevationDomainValid","programHandle","program","handle","colorIndex","getUniformBlockIndex","elevationIndex","uniformBlockBinding","layerName"],"mappings":"AAoBA,SAAQA,KAAR,QAAoB,eAApB;AAEA,SAAQC,KAAR,EAAeC,YAAf,EAA6BC,IAA7B,EAAmCC,aAAnC,QAAuD,eAAvD;MACOC,W,GAAeF,I,CAAfE,W;AACP,MAAMC,eAAe,GAAG,IAAIF,aAAJ,EAAxB;AACA,SAAQG,iBAAR,QAAgC,sBAAhC;AAEA,OAAOC,EAAP,MAAe,mCAAf;AACA,OAAOC,EAAP,MAAe,qCAAf;AAEA,MAAMC,oBAAoB,GAAG,CAA7B;AACA,MAAMC,wBAAwB,GAAG,CAAjC;AAEA,MAAMC,YAAY,GAAG;AAEnBC,EAAAA,WAAW,EAAE,IAFM;AAGnBC,EAAAA,UAAU,EAAEP,iBAHO;AAMnBQ,EAAAA,eAAe,EAAE,IANE;AAOnBC,EAAAA,cAAc,EAAE,CAAC,CAAD,EAAI,IAAJ,CAPG;AAQnBC,EAAAA,cAAc,EAAE;AAACC,IAAAA,IAAI,EAAE,QAAP;AAAiBC,IAAAA,GAAG,EAAE,CAAtB;AAAyBC,IAAAA,KAAK,EAAE;AAAhC,GARG;AAWnBC,EAAAA,QAAQ,EAAE;AAACH,IAAAA,IAAI,EAAE,OAAP;AAAgBC,IAAAA,GAAG,EAAE,CAArB;AAAwBC,IAAAA,KAAK,EAAE,CAAC,CAAD,EAAI,CAAJ;AAA/B,GAXS;AAYnBE,EAAAA,UAAU,EAAE;AAACJ,IAAAA,IAAI,EAAE,OAAP;AAAgBC,IAAAA,GAAG,EAAE,CAArB;AAAwBC,IAAAA,KAAK,EAAE,CAAC,CAAD,EAAI,CAAJ;AAA/B,GAZO;AAanBG,EAAAA,UAAU,EAAE;AAACL,IAAAA,IAAI,EAAE,OAAP;AAAgBC,IAAAA,GAAG,EAAE,CAArB;AAAwBC,IAAAA,KAAK,EAAE,CAAC,CAAD,EAAI,CAAJ;AAA/B,GAbO;AAenBI,EAAAA,QAAQ,EAAE;AAACN,IAAAA,IAAI,EAAE,QAAP;AAAiBC,IAAAA,GAAG,EAAE,CAAtB;AAAyBM,IAAAA,GAAG,EAAE,IAA9B;AAAoCL,IAAAA,KAAK,EAAE;AAA3C,GAfS;AAgBnBM,EAAAA,MAAM,EAAE;AAACR,IAAAA,IAAI,EAAE,OAAP;AAAgBC,IAAAA,GAAG,EAAE,CAArB;AAAwBC,IAAAA,KAAK,EAAE,CAAC,CAAD,EAAI,CAAJ;AAA/B,GAhBW;AAiBnBO,EAAAA,QAAQ,EAAE;AAACT,IAAAA,IAAI,EAAE,QAAP;AAAiBC,IAAAA,GAAG,EAAE,CAAtB;AAAyBM,IAAAA,GAAG,EAAE,CAA9B;AAAiCL,IAAAA,KAAK,EAAE;AAAxC,GAjBS;AAkBnBQ,EAAAA,QAAQ,EAAE,IAlBS;AAmBnBzB,EAAAA,IAAI,EAAE,KAnBa;AAoBnB0B,EAAAA,QAAQ,EAAEvB;AApBS,CAArB;AAuBA,eAAe,MAAMwB,gBAAN,SAA+B9B,KAA/B,CAAqC;AAClD+B,EAAAA,UAAU,GAAG;AACX,WAAO;AAACvB,MAAAA,EAAD;AAAKC,MAAAA,EAAL;AAASuB,MAAAA,OAAO,EAAE,CAAC,WAAD,EAAc,kBAAd,EAAkC,SAAlC,EAA6C,MAA7C;AAAlB,KAAP;AACD;;AAEDC,EAAAA,eAAe,GAAG;AAAA,UACTC,EADS,GACH,KAAKC,OADF,CACTD,EADS;AAEhB,UAAME,gBAAgB,GAAG,KAAKC,mBAAL,EAAzB;AACAD,IAAAA,gBAAgB,CAACE,YAAjB,CAA8B;AAC5BC,MAAAA,MAAM,EAAE;AACNC,QAAAA,IAAI,EAAE,CADA;AAENC,QAAAA,MAAM,EAAE,KAAKC,eAFP;AAGNC,QAAAA,OAAO,EAAE;AAHH,OADoB;AAM5BC,MAAAA,UAAU,EAAE;AACVJ,QAAAA,IAAI,EAAE,CADI;AAEVC,QAAAA,MAAM,EAAE,KAAKI,mBAFH;AAGVF,QAAAA,OAAO,EAAE;AAHC;AANgB,KAA9B;;AAYA,UAAMG,KAAK,GAAG,KAAKC,SAAL,CAAeb,EAAf,CAAd;;AACA,SAAKc,mBAAL,CAAyBF,KAAzB;;AACA,SAAKG,QAAL,CAAc;AAACH,MAAAA;AAAD,KAAd;AACD;;AAEDC,EAAAA,SAAS,CAACb,EAAD,EAAK;AACZ,WAAO,IAAIjC,KAAJ,CACLiC,EADK,EAELgB,MAAM,CAACC,MAAP,CAAc,EAAd,EAAkB,KAAKpB,UAAL,EAAlB,EAAqC;AACnCqB,MAAAA,EAAE,EAAE,KAAKC,KAAL,CAAWD,EADoB;AAEnCE,MAAAA,QAAQ,EAAE,IAAIpD,YAAJ,EAFyB;AAGnCqD,MAAAA,WAAW,EAAE,IAHsB;AAInCC,MAAAA,WAAW,EAAE,KAAKrB,OAAL,CAAaqB;AAJS,KAArC,CAFK,CAAP;AASD;;AAEDC,EAAAA,IAAI,OAAa;AAAA,QAAXC,QAAW,QAAXA,QAAW;AAAA,wBAaX,KAAKL,KAbM;AAAA,UAEbM,IAFa,eAEbA,IAFa;AAAA,UAGbnC,QAHa,eAGbA,QAHa;AAAA,UAIbE,MAJa,eAIbA,MAJa;AAAA,UAKbE,QALa,eAKbA,QALa;AAAA,UAMbX,cANa,eAMbA,cANa;AAAA,UAObU,QAPa,eAObA,QAPa;AAAA,UAQbN,QARa,eAQbA,QARa;AAAA,UASbC,UATa,eASbA,UATa;AAAA,UAUbC,UAVa,eAUbA,UAVa;AAAA,UAWbT,UAXa,eAWbA,UAXa;AAAA,UAYbE,cAZa,eAYbA,cAZa;AAef,UAAM4C,aAAa,GAAG,CAACvD,WAAW,CAACiB,UAAU,CAAC,CAAD,CAAX,CAAZ,EAA6BjB,WAAW,CAACiB,UAAU,CAAC,CAAD,CAAX,CAAxC,CAAtB;AACA,UAAMuC,aAAa,GAAG,CAACxD,WAAW,CAACkB,UAAU,CAAC,CAAD,CAAX,CAAZ,EAA6BlB,WAAW,CAACkB,UAAU,CAAC,CAAD,CAAX,CAAxC,CAAtB;AACA,UAAMuC,iBAAiB,GAAGH,IAAI,CAACI,KAAL,CAAWC,YAArC;AACA,UAAMC,qBAAqB,GAAGN,IAAI,CAACO,SAAL,CAAeF,YAA7C;AAEAF,IAAAA,iBAAiB,CAACK,IAAlB,CAAuB;AAACC,MAAAA,MAAM,OAAP;AAA4BC,MAAAA,KAAK,EAAE3D;AAAnC,KAAvB;AACAuD,IAAAA,qBAAqB,CAACE,IAAtB,CAA2B;AAACC,MAAAA,MAAM,OAAP;AAA4BC,MAAAA,KAAK,EAAE1D;AAAnC,KAA3B;AACA,UAAM2D,cAAc,GAAG,KAAKC,iBAAL,EAAvB;AAEA,SAAKC,KAAL,CAAW1B,KAAX,CACG2B,WADH,CAEIvB,MAAM,CAACC,MAAP,CAAc,EAAd,EAAkBO,QAAlB,EAA4BY,cAA5B,EAA4C;AAC1C9C,MAAAA,QAD0C;AAE1CE,MAAAA,MAF0C;AAG1CE,MAAAA,QAH0C;AAI1CX,MAAAA,cAJ0C;AAK1CU,MAAAA,QAL0C;AAM1CN,MAAAA,QAN0C;AAO1CC,MAAAA,UAP0C;AAQ1CsC,MAAAA,aAR0C;AAS1CrC,MAAAA,UAT0C;AAU1CsC,MAAAA,aAV0C;AAW1C/C,MAAAA,UAX0C;AAY1CE,MAAAA;AAZ0C,KAA5C,CAFJ,EAiBGyC,IAjBH;AAkBAK,IAAAA,iBAAiB,CAACY,MAAlB,CAAyB;AAACN,MAAAA,MAAM,OAAP;AAA4BC,MAAAA,KAAK,EAAE3D;AAAnC,KAAzB;AACAuD,IAAAA,qBAAqB,CAACS,MAAtB,CAA6B;AAACN,MAAAA,MAAM,OAAP;AAA4BC,MAAAA,KAAK,EAAE1D;AAAnC,KAA7B;AACD;;AAED+B,EAAAA,eAAe,CAACiC,SAAD,EAAY;AAAA,UAClBhB,IADkB,GACV,KAAKN,KADK,CAClBM,IADkB;AAEzBgB,IAAAA,SAAS,CAAClC,MAAV,CAAiB;AACfmC,MAAAA,MAAM,EAAEjB,IAAI,CAACI,KAAL,CAAWc;AADJ,KAAjB;AAGD;;AAEDhC,EAAAA,mBAAmB,CAAC8B,SAAD,EAAY;AAAA,UACtBhB,IADsB,GACd,KAAKN,KADS,CACtBM,IADsB;AAE7BgB,IAAAA,SAAS,CAAClC,MAAV,CAAiB;AACfmC,MAAAA,MAAM,EAAEjB,IAAI,CAACO,SAAL,CAAeW;AADR,KAAjB;AAGD;;AAEDN,EAAAA,iBAAiB,GAAG;AAAA,yBACqB,KAAKlB,KAD1B;AAAA,UACXxC,WADW,gBACXA,WADW;AAAA,UACEE,eADF,gBACEA,eADF;AAElB,UAAMuD,cAAc,GAAG,EAAvB;;AACA,QAAIzD,WAAW,KAAK,IAApB,EAA0B;AACxByD,MAAAA,cAAc,CAACQ,gBAAf,GAAkC,IAAlC;AACAR,MAAAA,cAAc,CAACzD,WAAf,GAA6BA,WAA7B;AACD,KAHD,MAGO;AACLyD,MAAAA,cAAc,CAACQ,gBAAf,GAAkC,KAAlC;AACD;;AACD,QAAI/D,eAAe,KAAK,IAAxB,EAA8B;AAC5BuD,MAAAA,cAAc,CAACS,oBAAf,GAAsC,IAAtC;AACAT,MAAAA,cAAc,CAACvD,eAAf,GAAiCA,eAAjC;AACD,KAHD,MAGO;AACLuD,MAAAA,cAAc,CAACS,oBAAf,GAAsC,KAAtC;AACD;;AACD,WAAOT,cAAP;AACD;;AAEDtB,EAAAA,mBAAmB,CAACF,KAAD,EAAQ;AACzB,UAAMZ,EAAE,GAAG,KAAKC,OAAL,CAAaD,EAAxB;AACA,UAAM8C,aAAa,GAAGlC,KAAK,CAACmC,OAAN,CAAcC,MAApC;AAEA,UAAMC,UAAU,GAAGjD,EAAE,CAACkD,oBAAH,CAAwBJ,aAAxB,EAAuC,WAAvC,CAAnB;AACA,UAAMK,cAAc,GAAGnD,EAAE,CAACkD,oBAAH,CAAwBJ,aAAxB,EAAuC,eAAvC,CAAvB;AACA9C,IAAAA,EAAE,CAACoD,mBAAH,CAAuBN,aAAvB,EAAsCG,UAAtC,EAAkDzE,oBAAlD;AACAwB,IAAAA,EAAE,CAACoD,mBAAH,CAAuBN,aAAvB,EAAsCK,cAAtC,EAAsD1E,wBAAtD;AACD;;AA3HiD;AA8HpDmB,gBAAgB,CAACyD,SAAjB,GAA6B,kBAA7B;AACAzD,gBAAgB,CAAClB,YAAjB,GAAgCA,YAAhC","sourcesContent":["// Copyright (c) 2015 - 2017 Uber Technologies, Inc.\n//\n// Permission is hereby granted, free of charge, to any person obtaining a copy\n// of this software and associated documentation files (the \"Software\"), to deal\n// in the Software without restriction, including without limitation the rights\n// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n// copies of the Software, and to permit persons to whom the Software is\n// furnished to do so, subject to the following conditions:\n//\n// The above copyright notice and this permission notice shall be included in\n// all copies or substantial portions of the Software.\n//\n// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n// THE SOFTWARE.\n\nimport {Layer} from '@deck.gl/core';\nimport GL from '@luma.gl/constants';\nimport {Model, CubeGeometry, fp64, PhongMaterial} from '@luma.gl/core';\nconst {fp64LowPart} = fp64;\nconst defaultMaterial = new PhongMaterial();\nimport {defaultColorRange} from '../utils/color-utils';\n\nimport vs from './gpu-grid-cell-layer-vertex.glsl';\nimport fs from './gpu-grid-cell-layer-fragment.glsl';\n\nconst COLOR_DATA_UBO_INDEX = 0;\nconst ELEVATION_DATA_UBO_INDEX = 1;\n\nconst defaultProps = {\n  // color\n  colorDomain: null,\n  colorRange: defaultColorRange,\n\n  // elevation\n  elevationDomain: null,\n  elevationRange: [0, 1000],\n  elevationScale: {type: 'number', min: 0, value: 1},\n\n  // grid\n  gridSize: {type: 'array', min: 0, value: [1, 1]},\n  gridOrigin: {type: 'array', min: 0, value: [0, 0]},\n  gridOffset: {type: 'array', min: 0, value: [0, 0]},\n\n  cellSize: {type: 'number', min: 0, max: 1000, value: 1000},\n  offset: {type: 'array', min: 0, value: [1, 1]},\n  coverage: {type: 'number', min: 0, max: 1, value: 1},\n  extruded: true,\n  fp64: false,\n  material: defaultMaterial\n};\n\nexport default class GPUGridCellLayer extends Layer {\n  getShaders() {\n    return {vs, fs, modules: ['project32', 'gouraud-lighting', 'picking', 'fp64']};\n  }\n\n  initializeState() {\n    const {gl} = this.context;\n    const attributeManager = this.getAttributeManager();\n    attributeManager.addInstanced({\n      colors: {\n        size: 4,\n        update: this.calculateColors,\n        noAlloc: true\n      },\n      elevations: {\n        size: 4,\n        update: this.calculateElevations,\n        noAlloc: true\n      }\n    });\n    const model = this._getModel(gl);\n    this._setupUniformBuffer(model);\n    this.setState({model});\n  }\n\n  _getModel(gl) {\n    return new Model(\n      gl,\n      Object.assign({}, this.getShaders(), {\n        id: this.props.id,\n        geometry: new CubeGeometry(),\n        isInstanced: true,\n        shaderCache: this.context.shaderCache\n      })\n    );\n  }\n\n  draw({uniforms}) {\n    const {\n      data,\n      cellSize,\n      offset,\n      extruded,\n      elevationScale,\n      coverage,\n      gridSize,\n      gridOrigin,\n      gridOffset,\n      colorRange,\n      elevationRange\n    } = this.props;\n\n    const gridOriginLow = [fp64LowPart(gridOrigin[0]), fp64LowPart(gridOrigin[1])];\n    const gridOffsetLow = [fp64LowPart(gridOffset[0]), fp64LowPart(gridOffset[1])];\n    const colorMaxMinBuffer = data.color.maxMinBuffer;\n    const elevationMaxMinBuffer = data.elevation.maxMinBuffer;\n\n    colorMaxMinBuffer.bind({target: GL.UNIFORM_BUFFER, index: COLOR_DATA_UBO_INDEX});\n    elevationMaxMinBuffer.bind({target: GL.UNIFORM_BUFFER, index: ELEVATION_DATA_UBO_INDEX});\n    const domainUniforms = this.getDomainUniforms();\n\n    this.state.model\n      .setUniforms(\n        Object.assign({}, uniforms, domainUniforms, {\n          cellSize,\n          offset,\n          extruded,\n          elevationScale,\n          coverage,\n          gridSize,\n          gridOrigin,\n          gridOriginLow,\n          gridOffset,\n          gridOffsetLow,\n          colorRange,\n          elevationRange\n        })\n      )\n      .draw();\n    colorMaxMinBuffer.unbind({target: GL.UNIFORM_BUFFER, index: COLOR_DATA_UBO_INDEX});\n    elevationMaxMinBuffer.unbind({target: GL.UNIFORM_BUFFER, index: ELEVATION_DATA_UBO_INDEX});\n  }\n\n  calculateColors(attribute) {\n    const {data} = this.props;\n    attribute.update({\n      buffer: data.color.aggregationBuffer\n    });\n  }\n\n  calculateElevations(attribute) {\n    const {data} = this.props;\n    attribute.update({\n      buffer: data.elevation.aggregationBuffer\n    });\n  }\n\n  getDomainUniforms() {\n    const {colorDomain, elevationDomain} = this.props;\n    const domainUniforms = {};\n    if (colorDomain !== null) {\n      domainUniforms.colorDomainValid = true;\n      domainUniforms.colorDomain = colorDomain;\n    } else {\n      domainUniforms.colorDomainValid = false;\n    }\n    if (elevationDomain !== null) {\n      domainUniforms.elevationDomainValid = true;\n      domainUniforms.elevationDomain = elevationDomain;\n    } else {\n      domainUniforms.elevationDomainValid = false;\n    }\n    return domainUniforms;\n  }\n\n  _setupUniformBuffer(model) {\n    const gl = this.context.gl;\n    const programHandle = model.program.handle;\n\n    const colorIndex = gl.getUniformBlockIndex(programHandle, 'ColorData');\n    const elevationIndex = gl.getUniformBlockIndex(programHandle, 'ElevationData');\n    gl.uniformBlockBinding(programHandle, colorIndex, COLOR_DATA_UBO_INDEX);\n    gl.uniformBlockBinding(programHandle, elevationIndex, ELEVATION_DATA_UBO_INDEX);\n  }\n}\n\nGPUGridCellLayer.layerName = 'GPUGridCellLayer';\nGPUGridCellLayer.defaultProps = defaultProps;\n"],"file":"gpu-grid-cell-layer.js"}