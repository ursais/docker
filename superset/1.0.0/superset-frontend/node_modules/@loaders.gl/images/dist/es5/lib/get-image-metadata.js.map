{"version":3,"sources":["../../../src/lib/get-image-metadata.js"],"names":["ERR_INVALID_MIME_TYPE","Array","from","mimeTypeMap","keys","join","isImage","arrayBuffer","mimeType","getImageTypeHandlers","test","dataView","toDataView","Boolean","getImageMIMEType","entries","getImageSize","getSize","size","Error","getImageMetadata","metadata","handlers","get","data","ArrayBuffer","isView","DataView","buffer"],"mappings":";;;;;;;;;;;;;;AAQA;;AAEA,IAAMA,qBAAqB,0DAAmDC,KAAK,CAACC,IAAN,CAC5EC,0BAAYC,IAAZ,EAD4E,EAE5EC,IAF4E,CAEvE,IAFuE,CAAnD,CAA3B;;AAKO,SAASC,OAAT,CAAiBC,WAAjB,EAA8BC,QAA9B,EAAwC;AAC7C,MAAIA,QAAJ,EAAc;AAAA,gCACGC,oBAAoB,CAACD,QAAD,CADvB;AAAA,QACLE,IADK,yBACLA,IADK;;AAEZ,QAAMC,QAAQ,GAAGC,UAAU,CAACL,WAAD,CAA3B;AACA,WAAOG,IAAI,CAACC,QAAD,CAAX;AACD;;AAED,SAAOE,OAAO,CAACC,gBAAgB,CAACP,WAAD,CAAjB,CAAd;AACD;;AAGM,SAASO,gBAAT,CAA0BP,WAA1B,EAAuC;AAC5C,MAAMI,QAAQ,GAAGC,UAAU,CAACL,WAAD,CAA3B;AAD4C;AAAA;AAAA;;AAAA;AAI5C,yBAAiCJ,0BAAYY,OAAZ,EAAjC,8HAAwD;AAAA;AAAA,UAA5CP,QAA4C;AAAA,UAAjCE,IAAiC,kBAAjCA,IAAiC;;AACtD,UAAIA,IAAI,CAACC,QAAD,CAAR,EAAoB;AAClB,eAAOH,QAAP;AACD;AACF;AAR2C;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAU5C,SAAO,IAAP;AACD;;AAEM,SAASQ,YAAT,CAAsBT,WAAtB,EAAoD;AAAA,MAAjBC,QAAiB,uEAAN,IAAM;AACzDA,EAAAA,QAAQ,GAAGA,QAAQ,IAAIM,gBAAgB,CAACP,WAAD,CAAvC;;AADyD,+BAGvCE,oBAAoB,CAACD,QAAD,CAHmB;AAAA,MAGlDS,OAHkD,0BAGlDA,OAHkD;;AAKzD,MAAMN,QAAQ,GAAGC,UAAU,CAACL,WAAD,CAA3B;AACA,MAAMW,IAAI,GAAGD,OAAO,CAACN,QAAD,CAApB;;AAEA,MAAI,CAACO,IAAL,EAAW;AACT,UAAM,IAAIC,KAAJ,wCAA0CX,QAA1C,EAAN;AACD;;AAED,SAAOU,IAAP;AACD;;AAIM,SAASE,gBAAT,CAA0Bb,WAA1B,EAAwD;AAAA,MAAjBC,QAAiB,uEAAN,IAAM;AAC7DA,EAAAA,QAAQ,GAAGA,QAAQ,IAAIM,gBAAgB,CAACP,WAAD,CAAvC;AAEA,MAAMc,QAAQ,GAAGL,YAAY,CAACT,WAAD,EAAcC,QAAd,CAA7B;AACAa,EAAAA,QAAQ,CAACb,QAAT,GAAoBA,QAApB;AACA,SAAOa,QAAP;AACD;;AAED,SAASZ,oBAAT,CAA8BD,QAA9B,EAAwC;AACtC,MAAMc,QAAQ,GAAGnB,0BAAYoB,GAAZ,CAAgBf,QAAhB,CAAjB;;AACA,MAAI,CAACc,QAAL,EAAe;AACb,UAAM,IAAIH,KAAJ,CAAUnB,qBAAV,CAAN;AACD;;AACD,SAAOsB,QAAP;AACD;;AAED,SAASV,UAAT,CAAoBY,IAApB,EAA0B;AAOxB,MAAIA,IAAI,YAAYC,WAAhB,IAA+BA,WAAW,CAACC,MAAZ,CAAmBF,IAAnB,CAAnC,EAA6D;AAC3D,WAAO,IAAIG,QAAJ,CAAaH,IAAI,CAACI,MAAL,IAAeJ,IAA5B,CAAP;AACD;;AAED,QAAM,IAAIL,KAAJ,CAAU,YAAV,CAAN;AACD","sourcesContent":["// Attributions\n// * Based on binary-gltf-utils under MIT license: Copyright (c) 2016-17 Karl Cheng\n\n// TODO: make these functions work for Node.js buffers?\n// Quarantine references to Buffer to prevent bundler from adding big polyfills\n// import {bufferToArrayBuffer} from '../node/buffer-to-array-buffer';\n// TODO - this should be handled in @loaders.gl/polyfills\n\nimport {mimeTypeMap} from './image-parsers';\n\nconst ERR_INVALID_MIME_TYPE = `Invalid MIME type. Supported MIME types are: ${Array.from(\n  mimeTypeMap.keys()\n).join(', ')}`;\n\n// Supported image types are PNG, JPEG, GIF and BMP.\nexport function isImage(arrayBuffer, mimeType) {\n  if (mimeType) {\n    const {test} = getImageTypeHandlers(mimeType);\n    const dataView = toDataView(arrayBuffer);\n    return test(dataView);\n  }\n  // check if known type\n  return Boolean(getImageMIMEType(arrayBuffer));\n}\n\n// Sniffs the contents of a file to attempt to deduce the image type\nexport function getImageMIMEType(arrayBuffer) {\n  const dataView = toDataView(arrayBuffer);\n\n  // Loop through each file type and see if they work.\n  for (const [mimeType, {test}] of mimeTypeMap.entries()) {\n    if (test(dataView)) {\n      return mimeType;\n    }\n  }\n\n  return null;\n}\n\nexport function getImageSize(arrayBuffer, mimeType = null) {\n  mimeType = mimeType || getImageMIMEType(arrayBuffer);\n\n  const {getSize} = getImageTypeHandlers(mimeType);\n\n  const dataView = toDataView(arrayBuffer);\n  const size = getSize(dataView);\n\n  if (!size) {\n    throw new Error(`invalid image data for type: ${mimeType}`);\n  }\n\n  return size;\n}\n\n// Sniffs the contents of a file to attempt to deduce the image type and size.\n// Supported image types are PNG, JPEG, GIF and BMP.\nexport function getImageMetadata(arrayBuffer, mimeType = null) {\n  mimeType = mimeType || getImageMIMEType(arrayBuffer);\n\n  const metadata = getImageSize(arrayBuffer, mimeType);\n  metadata.mimeType = mimeType;\n  return metadata;\n}\n\nfunction getImageTypeHandlers(mimeType) {\n  const handlers = mimeTypeMap.get(mimeType);\n  if (!handlers) {\n    throw new Error(ERR_INVALID_MIME_TYPE);\n  }\n  return handlers;\n}\n\nfunction toDataView(data) {\n  // TODO: make these functions work for Node.js buffers?\n  // if (bufferToArrayBuffer) {\n  //   data = bufferToArrayBuffer(data);\n  // }\n\n  // Careful - Node Buffers will look like ArrayBuffers (keep after isBuffer)\n  if (data instanceof ArrayBuffer || ArrayBuffer.isView(data)) {\n    return new DataView(data.buffer || data);\n  }\n\n  throw new Error('toDataView');\n}\n"],"file":"get-image-metadata.js"}