{"version":3,"sources":["../../../src/lib/parse-image.js"],"names":["global","getImageMetadata","canParseImage","_parseImageNode","ImageBitmap","parseImage","arrayBuffer","options","mimeType","parseToImageBitmap","loadImage","url","Image","response","fetch","loadToHTMLImage","createImageBitmap","Error","blob","Blob","Uint8Array","src","test","xml","text","btoa","Promise","resolve","reject","image","onload","onerror","err","crossOrigin","error"],"mappings":"AACA,SAAQA,MAAR,QAAqB,kBAArB;AACA,SAAQC,gBAAR,QAA+B,sBAA/B;AAEA,OAAO,MAAMC,aAAa,GAAGF,MAAM,CAACG,eAAP,IAA0B,OAAOC,WAAP,KAAuB,WAAvE;AAGP,OAAO,SAASC,UAAT,CAAoBC,WAApB,EAAiCC,OAAjC,EAA0C;AAC/C,MAAIP,MAAM,CAACG,eAAX,EAA4B;AAC1B,UAAM;AAACK,MAAAA;AAAD,QAAaP,gBAAgB,CAACK,WAAD,CAAnC;AACA,WAAON,MAAM,CAACG,eAAP,CAAuBG,WAAvB,EAAoCE,QAApC,EAA8CD,OAA9C,CAAP;AACD;;AAED,SAAOE,kBAAkB,CAACH,WAAD,EAAcC,OAAd,CAAzB;AACD;AAKD,OAAO,eAAeG,SAAf,CAAyBC,GAAzB,EAA8BJ,OAAO,GAAG,EAAxC,EAA4C;AACjD,MAAI,OAAOK,KAAP,KAAiB,WAArB,EAAkC;AAChC,UAAMC,QAAQ,GAAG,MAAMC,KAAK,CAACH,GAAD,EAAMJ,OAAN,CAA5B;AACA,UAAMD,WAAW,GAAG,MAAMO,QAAQ,CAACP,WAAT,EAA1B;AACA,WAAOD,UAAU,CAACC,WAAD,EAAcC,OAAd,CAAjB;AACD;;AACD,SAAO,MAAMQ,eAAe,CAACJ,GAAD,EAAMJ,OAAN,CAA5B;AACD;AAMD,OAAO,SAASE,kBAAT,CAA4BH,WAA5B,EAAyCC,OAAzC,EAAkD;AACvD,MAAI,OAAOS,iBAAP,KAA6B,WAAjC,EAA8C;AAC5C,UAAM,IAAIC,KAAJ,CAAU,YAAV,CAAN;AACD;;AAED,QAAMC,IAAI,GAAG,IAAIC,IAAJ,CAAS,CAAC,IAAIC,UAAJ,CAAed,WAAf,CAAD,CAAT,CAAb;AACA,SAAOU,iBAAiB,CAACE,IAAD,CAAxB;AACD;AAGD,OAAO,eAAeH,eAAf,CAA+BJ,GAA/B,EAAoCJ,OAApC,EAA6C;AAClD,MAAIc,GAAJ;;AACA,MAAI,oBAAoBC,IAApB,CAAyBX,GAAzB,CAAJ,EAAmC;AAEjC,UAAME,QAAQ,GAAG,MAAMC,KAAK,CAACH,GAAD,EAAMJ,OAAN,CAA5B;AACA,UAAMgB,GAAG,GAAG,MAAMV,QAAQ,CAACW,IAAT,EAAlB;AAEAH,IAAAA,GAAG,uCAAgCI,IAAI,CAACF,GAAD,CAApC,CAAH;AACD,GAND,MAMO;AACLF,IAAAA,GAAG,GAAG,MAAMV,GAAZ;AACD;;AAED,SAAO,MAAM,IAAIe,OAAJ,CAAY,CAACC,OAAD,EAAUC,MAAV,KAAqB;AAC5C,QAAI;AACF,YAAMC,KAAK,GAAG,IAAIjB,KAAJ,EAAd;;AACAiB,MAAAA,KAAK,CAACC,MAAN,GAAe,MAAMH,OAAO,CAACE,KAAD,CAA5B;;AACAA,MAAAA,KAAK,CAACE,OAAN,GAAgBC,GAAG,IAAIJ,MAAM,CAAC,IAAIX,KAAJ,gCAAkCN,GAAlC,eAA0CqB,GAA1C,EAAD,CAA7B;;AACAH,MAAAA,KAAK,CAACI,WAAN,GAAqB1B,OAAO,IAAIA,OAAO,CAAC0B,WAApB,IAAoC,WAAxD;AACAJ,MAAAA,KAAK,CAACR,GAAN,GAAYA,GAAZ;AACD,KAND,CAME,OAAOa,KAAP,EAAc;AACdN,MAAAA,MAAM,CAACM,KAAD,CAAN;AACD;AACF,GAVY,CAAb;AAWD","sourcesContent":["/* global Image, Blob, createImageBitmap, btoa, fetch */\nimport {global} from '../utils/globals';\nimport {getImageMetadata} from './get-image-metadata';\n\nexport const canParseImage = global._parseImageNode || typeof ImageBitmap !== 'undefined';\n\n// Parse to platform defined type (ndarray on node, ImageBitmap on browser)\nexport function parseImage(arrayBuffer, options) {\n  if (global._parseImageNode) {\n    const {mimeType} = getImageMetadata(arrayBuffer);\n    return global._parseImageNode(arrayBuffer, mimeType, options);\n  }\n\n  return parseToImageBitmap(arrayBuffer, options);\n}\n\n// Fallback for older browsers\n// TODO - investigate Image.decode()\n// https://medium.com/dailyjs/image-loading-with-image-decode-b03652e7d2d2\nexport async function loadImage(url, options = {}) {\n  if (typeof Image === 'undefined') {\n    const response = await fetch(url, options);\n    const arrayBuffer = await response.arrayBuffer();\n    return parseImage(arrayBuffer, options);\n  }\n  return await loadToHTMLImage(url, options);\n}\n\n// Asynchronously parses an array buffer into an ImageBitmap - this contains the decoded data\n// Supported on worker threads\n// Not supported on Edge and Safari\n// https://developer.mozilla.org/en-US/docs/Web/API/ImageBitmap#Browser_compatibility\nexport function parseToImageBitmap(arrayBuffer, options) {\n  if (typeof createImageBitmap === 'undefined') {\n    throw new Error('parseImage');\n  }\n\n  const blob = new Blob([new Uint8Array(arrayBuffer)]);\n  return createImageBitmap(blob);\n}\n\n//\nexport async function loadToHTMLImage(url, options) {\n  let src;\n  if (/\\.svg((\\?|#).*)?$/.test(url)) {\n    // is SVG\n    const response = await fetch(url, options);\n    const xml = await response.text();\n    // base64 encoding is safer. utf-8 fails in some browsers\n    src = `data:image/svg+xml;base64,${btoa(xml)}`;\n  } else {\n    src = await url;\n  }\n\n  return await new Promise((resolve, reject) => {\n    try {\n      const image = new Image();\n      image.onload = () => resolve(image);\n      image.onerror = err => reject(new Error(`Could not load image ${url}: ${err}`));\n      image.crossOrigin = (options && options.crossOrigin) || 'anonymous';\n      image.src = src;\n    } catch (error) {\n      reject(error);\n    }\n  });\n}\n"],"file":"parse-image.js"}